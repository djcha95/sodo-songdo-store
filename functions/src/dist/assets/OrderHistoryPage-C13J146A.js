import{b as ee,h as se,r as a,i as te,k as ae,l as re,E as ne,V as A,j as e,F as oe,G as ie,T as ce,R as $,u as W}from"./index-BMz7zIRN.js";import{c as le}from"./orderService-Bzti28Gn.js";import{u as K}from"./useLongPress-C3c2NboI.js";import{d as U}from"./dayjs.min-B5lyAaGD.js";import{I as L}from"./InlineSodomallLoader-CN_E-RXV.js";import{g as V}from"./imageUtils-BPiZeTFW.js";import{a as B,s as de}from"./toastUtils-C4esVHua.js";import{C as ue,a as me}from"./OrderHistoryPage-CL6bzVci.js";import{C as z}from"./circle-alert-CQEJXon4.js";import{L as pe}from"./list-ordered-a_4-UPcK.js";import{c as _}from"./createLucideIcon-Df3tO_ja.js";import{H as Z}from"./hourglass-Cbw8WS9u.js";import{A as H,m as R}from"./proxy-CA4nXXUX.js";import{I as q}from"./info-DxE8bBlt.js";import{P as fe}from"./package-x-CNBULsdo.js";import{P as G}from"./package-check-CP1CrOxf.js";import{P as ge}from"./package-CR9FldPL.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z",key:"yt0hxn"}],["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}]],xe=_("bolt",he);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["polyline",{points:"22 12 16 12 14 15 10 15 8 12 2 12",key:"o97t9d"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}]],je=_("inbox",ye);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]],Q=_("truck",Ne),T="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWFmMGY0Ii8+PC9zdmc+",ve="/event-snack-default.png",J=({src:s,alt:i,size:c="200x200",eager:t=!1,className:g})=>{const n=a.useMemo(()=>s&&s.trim()?s:T,[s]),h=a.useMemo(()=>n===T?T:V(n,c),[n,c]),[v,j]=a.useState(h),[y,b]=a.useState("none");a.useEffect(()=>{const N=V(n,c);j(N),b("none")},[n,c]);const f=a.useCallback(()=>{y!=="original-failed"&&(y==="none"?(console.error(`[SafeThumb ERROR] Optimized image failed to load: ${h}`),console.log(`[SafeThumb FALLBACK-1] Trying original URL: ${n}`),b("optimized-failed"),j(n)):y==="optimized-failed"&&(console.error(`[SafeThumb ERROR] Original image also failed: ${n}`),console.log("[SafeThumb FALLBACK-2] Displaying placeholder."),b("original-failed"),j(T)))},[y,h,n]);return e.jsx("img",{src:v,alt:i,className:`${g} ${y!=="none"?"image-error-fallback":""}`,loading:t?"eager":"lazy",fetchPriority:t?"high":"auto",onError:f})},C=s=>{if(!s)return null;if(s instanceof Date)return s;if(typeof s.toDate=="function")return s.toDate();if(typeof s=="object"&&(s.seconds!==void 0||s._seconds!==void 0)){const i=s.seconds??s._seconds,c=s.nanoseconds??s._nanoseconds??0;return new ce(i,c).toDate()}if(typeof s=="string"){const i=new Date(s);if(!isNaN(i.getTime()))return i}return null},be=s=>{const i=s.getFullYear().toString(),c=(s.getMonth()+1).toString().padStart(2,"0"),t=s.getDate().toString().padStart(2,"0"),n=["일","월","화","수","목","금","토"][s.getDay()];return`${i}년 ${c}월 ${t}일 (${n})`},De=s=>{const c=["일","월","화","수","목","금","토"][s.getDay()];return`${s.getMonth()+1}/${s.getDate()}(${c})`},F=10,Ee=(s,i,c,t)=>{const[g,n]=a.useState([]),[h,v]=a.useState(!1),[j,y]=a.useState(!1),[b,f]=a.useState(!0),[N,M]=a.useState(null),D=a.useRef({loadingMore:j,hasMore:b,lastVisible:N});D.current={loadingMore:j,hasMore:b,lastVisible:N};const E=a.useCallback(async(w=!1)=>{if(!s){v(!1);return}if(w)v(!0),f(!0),M(null),n([]);else{if(D.current.loadingMore||!D.current.hasMore)return;y(!0)}try{const k=w?null:D.current.lastVisible,I={...c,pageSize:F,lastVisible:k},x=(await i(I)).data,P=Array.isArray(x)?x:x?.data,r=Array.isArray(x)?null:x?.lastDoc;Array.isArray(P)?(n(l=>w?P:[...l,...P]),M(r),(!r||P.length<F)&&f(!1)):(f(!1),w&&n([]))}catch(k){console.error("데이터 로딩 오류:",k),de("error",k.message||"데이터를 불러오는 데 실패했습니다.")}finally{v(!1),y(!1)}},[s,i,c]);a.useEffect(()=>{t&&E(!0)},[t,E]);const S=a.useCallback(()=>{E(!1)},[E]);return{data:g,setData:n,loading:h||j,hasMore:b,loadMore:S}},we=$.memo(({date:s})=>e.jsx("h2",{className:"date-header",children:be(s)})),Y=$.memo(({type:s="order"})=>{const i=W(),c={order:{icon:e.jsx(ge,{size:48,className:"empty-icon"}),title:"아직 예약 내역이 없어요",desc:"마음에 드는 상품을 찾아 예약해보세요!"},waitlist:{icon:e.jsx(je,{size:48,className:"empty-icon"}),title:"대기중인 상품이 없어요",desc:"품절 상품에 대기 신청을 해보세요!"},pickup:{icon:e.jsx(Q,{size:48,className:"empty-icon"}),title:"예정된 픽업이 없어요",desc:"다가올 픽업 예약이 여기에 표시됩니다."}},{icon:t,title:g,desc:n}=c[s];return e.jsxs("div",{className:"empty-history-container",children:[t,e.jsx("h3",{className:"empty-title",children:g}),e.jsx("p",{className:"empty-description",children:n}),e.jsx("button",{className:"go-to-shop-btn",onClick:()=>i("/"),children:"상품 보러 가기"})]})}),ke=$.memo(({item:s,displayDateInfo:i,onCancel:c})=>{const t=W(),g=a.useRef(!1),{statusText:n,StatusIcon:h,statusClass:v}=a.useMemo(()=>{if(s.wasPrepaymentRequired&&s.status==="RESERVED")return{statusText:"선입금 필요",StatusIcon:ue,statusClass:"status-prepayment_required"};const u={RESERVED:"예약 완료",PREPAID:"선입금 완료",PICKED_UP:"픽업 완료",COMPLETED:"처리 완료",CANCELED:"취소됨",NO_SHOW:"노쇼"},x={RESERVED:Z,PREPAID:G,PICKED_UP:G,COMPLETED:me,CANCELED:fe,NO_SHOW:z};return{statusText:u[s.status]||"알 수 없음",StatusIcon:x[s.status]||z,statusClass:`status-${s.status.toLowerCase()}`}},[s.status,s.wasPrepaymentRequired]),{cancellable:j,orderToCancel:y,cancelDisabledReason:b,isEvent:f}=a.useMemo(()=>{const u=s.originalOrders[0];if(!u)return{cancellable:!1,orderToCancel:void 0,cancelDisabledReason:null,isEvent:!1};const x=u.items?.[0];if(u?.eventId||x?.eventId||x?.roundId?.startsWith?.("welcome-")||x?.roundName?.includes?.("이벤트")||s.productName?.includes?.("랜덤간식")||typeof x?.unitPrice=="number"&&x?.unitPrice===0)return{cancellable:!1,orderToCancel:void 0,cancelDisabledReason:"이벤트 상품은 취소할 수 없습니다.",isEvent:!0};if(!(u.status==="RESERVED"||u.status==="PREPAID"))return{cancellable:!1,orderToCancel:void 0,cancelDisabledReason:null,isEvent:!1};const l=C(u.items?.[0]?.deadlineDate);return l&&new Date>l?{cancellable:!1,orderToCancel:void 0,cancelDisabledReason:"마감일이 지나 취소할 수 없습니다.",isEvent:!1}:{cancellable:!0,orderToCancel:u,cancelDisabledReason:null,isEvent:!1}},[s.originalOrders,s.productName]),N=a.useMemo(()=>f?s.productName:s.variantGroupName,[f,s.productName,s.variantGroupName]),M=a.useMemo(()=>f?s.originalOrders[0]?.items[0]?.roundName:s.itemName,[f,s.originalOrders,s.itemName]),D=()=>{g.current||(g.current=!0,j&&y&&c?c(y):b&&A.custom(u=>e.jsxs("div",{className:`confirmation-toast ${u.visible?"animate-enter":""}`,children:[e.jsxs("h4",{className:"toast-header",children:[e.jsx(q,{size:20}),e.jsx("span",{children:"취소 불가 안내"})]}),e.jsx("p",{className:"toast-message",children:b}),e.jsx("div",{className:"toast-buttons",children:e.jsx("button",{className:"common-button button-primary button-medium",onClick:()=>A.dismiss(u.id),children:"확인"})})]}),{duration:1/0,style:{background:"transparent",boxShadow:"none",padding:0}}))},E=()=>{g.current=!1},w=K(D,()=>{f||t(`/product/${s.productId}`)},{initialDelay:1500}),k={...w,onMouseUp:()=>{w.onMouseUp(),E()},onMouseLeave:()=>{w.onMouseLeave(),E()},onTouchEnd:()=>{w.onTouchEnd(),E()}};let I="";if(i?.date){const u=De(i.date);I=i.type==="pickup"?`픽업 ${u}`:`주문 ${u}`}return e.jsx(R.div,{className:`order-card-v3 ${j?"cancellable":""} ${f?"event-item":""}`,layoutId:s.stableId,...k,whileTap:f?{}:{scale:.97},transition:{duration:.2,ease:"easeInOut"},children:e.jsxs("div",{className:"card-v3-body",children:[e.jsx("div",{className:"item-image-wrapper",children:e.jsx(J,{src:s.imageUrl||(f?ve:void 0),alt:s.productName,className:"item-image"})}),e.jsxs("div",{className:"item-aggregated-info",children:[e.jsxs("div",{className:"info-top-row",children:[e.jsx("span",{className:"product-name-top",children:N}),e.jsxs("div",{className:"status-and-event-wrapper",children:[f&&e.jsx("span",{className:"event-badge",children:"이벤트"}),e.jsxs("span",{className:`status-badge ${v}`,children:[e.jsx(h,{size:14})," ",n]})]})]}),e.jsxs("div",{className:"info-bottom-row",children:[e.jsxs("span",{className:"item-options-quantity",children:[e.jsx("span",{className:"item-option-name",children:M}),e.jsxs("span",{className:"item-quantity",children:["(",s.totalQuantity,"개)"]})]}),I&&e.jsx("span",{className:"date-info-badge",children:I})]})]})]})},s.id)}),Ce=$.memo(({item:s,onCancel:i})=>{const c=W(),t=a.useRef(!1),g=()=>{t.current||(t.current=!0,i(s))},n=()=>{t.current=!1},h=K(g,()=>c(`/product/${s.productId}`),{initialDelay:1500}),v={...h,onMouseUp:()=>{h.onMouseUp(),n()},onMouseLeave:()=>{h.onMouseLeave(),n()},onTouchEnd:()=>{h.onTouchEnd(),n()}};return e.jsx(R.div,{className:"waitlist-card",layout:!0,...v,whileTap:{scale:.97},transition:{duration:.2,ease:"easeInOut"},children:e.jsxs("div",{className:"card-v3-body",children:[e.jsx("div",{className:"item-image-wrapper",children:e.jsx(J,{src:s.imageUrl||T,alt:s.productName,className:"item-image"})}),e.jsxs("div",{className:"item-aggregated-info",children:[e.jsxs("div",{className:"info-top-row",children:[e.jsx("span",{className:"product-name-top",children:s.productName}),s.waitlistOrder&&e.jsxs("span",{className:"waitlist-order-badge",children:[e.jsx(xe,{size:14}),"대기 ",s.waitlistOrder,"번"]})]}),e.jsx("div",{className:"info-bottom-row",children:e.jsxs("span",{className:"item-options-quantity",children:[e.jsx("span",{className:"item-option-name",children:s.itemName}),e.jsxs("span",{className:"item-quantity",children:["(",s.quantity,"개)"]})]})}),e.jsx("div",{className:"waitlist-actions",children:e.jsxs("div",{className:"cancel-instruction-waitlist",children:[e.jsx(q,{size:14}),e.jsx("span",{children:"카드를 길게 눌러 대기를 취소하세요."})]})})]})]})})}),Be=()=>{const{user:s,userDocument:i}=ee(),{runPageTourIfFirstTime:c}=se(),[t,g]=a.useState("orders"),[n,h]=a.useState([]),[v,j]=a.useState(!1),y=a.useMemo(()=>te(ae(),"asia-northeast3"),[]),b=a.useMemo(()=>re(y,"getUserOrders"),[y]),f=a.useMemo(()=>{if(t==="pickup"){const r=new Date;return r.setHours(0,0,0,0),{orderByField:"pickupDate",orderDirection:"asc",startDate:r.toISOString()}}return{orderByField:"createdAt",orderDirection:"desc"}},[t]),{data:N,setData:M,loading:D,hasMore:E,loadMore:S}=Ee(s?.uid,b,f,t==="orders"||t==="pickup");a.useEffect(()=>{i&&c("hasSeenOrderHistoryPage",ne)},[i,c]),a.useEffect(()=>{(async()=>{if(s&&t==="waitlist"){j(!0);try{const l=await ie(s.uid);h(l)}catch{A.error("대기 목록을 불러오는 데 실패했습니다.")}finally{j(!1)}}})()},[s,t]);const w=a.useMemo(()=>{const r={};N.forEach(o=>{const m=C(t==="orders"?o.createdAt:o.pickupDate);if(!m)return;const p=U(m).format("YYYY-MM-DD");(o.items||[]).forEach(d=>{const O=`${p}-${d.productId?.trim()??""}-${d.variantGroupName?.trim()??""}-${d.itemName?.trim()??""}-${o.wasPrepaymentRequired}-${o.status}-${o.eventId??""}`,X=`${d.productId?.trim()??""}-${d.variantGroupName?.trim()??""}-${d.itemName?.trim()??""}-${o.wasPrepaymentRequired}`;r[O]||(r[O]={id:O,stableId:X,productId:d.productId,productName:d.productName,variantGroupName:d.variantGroupName,itemName:d.itemName,totalQuantity:0,imageUrl:d.imageUrl,originalOrders:[],status:o.status,wasPrepaymentRequired:o.wasPrepaymentRequired??!1}),r[O].totalQuantity+=d.quantity,r[O].originalOrders.push(o)})}),Object.values(r).forEach(o=>{o.originalOrders.sort((m,p)=>(C(p.createdAt)?.getTime()||0)-(C(m.createdAt)?.getTime()||0))});const l={};return Object.values(r).forEach(o=>{const m=o.originalOrders[0];if(!m)return;const p=C(t==="orders"?m.createdAt:m.pickupDate);if(!p)return;const d=U(p).format("YYYY-MM-DD");l[d]||(l[d]=[]),l[d].push(o)}),l},[N,t]),k=a.useCallback(()=>{window.innerHeight+document.documentElement.scrollTop>=document.documentElement.offsetHeight-200&&(t==="orders"||t==="pickup")&&!D&&E&&S()},[t,D,E,S]);a.useEffect(()=>(window.addEventListener("scroll",k),()=>window.removeEventListener("scroll",k)),[k]);const I=a.useCallback(r=>{A.custom(l=>e.jsxs("div",{className:`confirmation-toast ${l.visible?"animate-enter":""}`,children:[e.jsxs("h4",{className:"toast-header",children:[e.jsx(z,{size:20}),e.jsx("span",{children:"예약 취소"})]}),e.jsx("p",{className:"toast-message",children:"정말 이 예약을 취소하시겠습니까?"}),e.jsxs("div",{className:"toast-buttons",children:[e.jsx("button",{className:"common-button button-secondary button-medium",onClick:()=>A.dismiss(l.id),children:"유지"}),e.jsx("button",{className:"common-button button-danger button-medium",onClick:()=>{A.dismiss(l.id);const o=le(r);B(o,{loading:"예약 취소 처리 중...",success:()=>(M(m=>m.map(p=>p.id===r.id?{...p,status:"CANCELED"}:p)),"예약이 성공적으로 취소되었습니다."),error:m=>m?.message||"취소 중 오류가 발생했습니다."})},children:"취소하기"})]})]}))},[M]),u=a.useCallback(async r=>{if(!s)return;const l=r.timestamp.toMillis();B(oe(r.productId,r.roundId,s.uid,r.itemId),{loading:"대기 취소 처리 중...",success:()=>(h(o=>o.filter(m=>m.timestamp.toMillis()!==l)),"대기 신청이 취소되었습니다."),error:"대기 취소 중 오류가 발생했습니다."})},[s,h]),x=()=>{if(D&&N.length===0)return e.jsx("div",{className:"loading-spinner-container",children:e.jsx(L,{})});if(N.length===0&&!D)return e.jsx(Y,{type:t==="pickup"?"pickup":"order"});const l=Object.keys(w).sort((o,m)=>{const p=new Date(o).getTime(),d=new Date(m).getTime();return t==="orders"?d-p:p-d});return e.jsx("div",{className:"orders-list",children:e.jsx(H,{children:l.map((o,m)=>e.jsxs(R.div,{layout:!0,children:[e.jsxs("div",{className:"date-header-container",children:[e.jsx(we,{date:new Date(o)}),m===0&&(t==="orders"||t==="pickup")&&e.jsxs("div",{className:"cancel-instruction","data-tutorial-id":"history-cancel-info",children:[e.jsx(q,{size:14}),e.jsx("span",{children:"카드를 길게 눌러 예약을 취소하세요."})]})]}),e.jsx("div",{className:"order-cards-grid",children:w[o].map(p=>e.jsx(ke,{item:p,displayDateInfo:t==="orders"?{type:"pickup",date:C(p.originalOrders[0]?.pickupDate)}:{type:"order",date:C(p.originalOrders[0]?.createdAt)},onCancel:I},p.id))})]},o))})})},P=()=>v?e.jsx("div",{className:"loading-spinner-container",children:e.jsx(L,{})}):n.length===0&&!v?e.jsx(Y,{type:"waitlist"}):e.jsx("div",{className:"waitlist-list",children:e.jsx(H,{children:n.map(r=>e.jsx(Ce,{item:r,onCancel:u},`${r.roundId}-${r.itemId}-${r.timestamp.toMillis()}`))})});return e.jsx("div",{className:"customer-page-container",children:e.jsxs("div",{className:"order-history-page",children:[e.jsxs("div",{className:"view-toggle-container","data-tutorial-id":"history-view-toggle",children:[e.jsxs("button",{className:`toggle-btn ${t==="orders"?"active":""}`,onClick:()=>g("orders"),children:[" ",e.jsx(pe,{size:18})," 주문일순 "]}),e.jsxs("button",{className:`toggle-btn ${t==="pickup"?"active":""}`,onClick:()=>g("pickup"),children:[" ",e.jsx(Q,{size:18})," 픽업일순 "]}),e.jsxs("button",{className:`toggle-btn ${t==="waitlist"?"active":""}`,onClick:()=>g("waitlist"),children:[" ",e.jsx(Z,{size:18})," 대기목록 "]})]}),e.jsx(H,{mode:"wait",children:e.jsx(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:t==="waitlist"?P():x()},t)}),(t==="orders"||t==="pickup")&&D&&N.length>0&&e.jsx("div",{className:"loading-more-spinner",children:e.jsx(L,{})}),(t==="orders"||t==="pickup")&&!E&&N.length>0&&e.jsx("div",{className:"end-of-list-message",children:"모든 내역을 불러왔습니다."})]})})};export{Be as default};
