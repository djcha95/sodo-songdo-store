import{r as l,i as R,k as Q,l as G,j as e,S as q,$ as A,a0 as O,a1 as V,a2 as z,C as H,a3 as K,V as g}from"./index-BMz7zIRN.js";import{u as L}from"./useDocumentTitle-BBAuQihd.js";import{T}from"./trending-up-BeywEaFl.js";import{c as B}from"./createLucideIcon-Df3tO_ja.js";import{H as F}from"./hourglass-Cbw8WS9u.js";import{C as W}from"./circle-check-big-B897TBEZ.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=[["path",{d:"M10 2v3a1 1 0 0 0 1 1h5",key:"1xspal"}],["path",{d:"M18 18v-6a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6",key:"1ra60u"}],["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"M8 18a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9.172a2 2 0 0 1 1.414.586l2.828 2.828A2 2 0 0 1 22 6.828V16a2 2 0 0 1-2.01 2z",key:"1yve0x"}]],U=B("save-all",_),Y=m=>{const y=m.getFullYear(),p=(m.getMonth()+1).toString().padStart(2,"0"),j=m.getDate().toString().padStart(2,"0");return`${y}-${p}-${j}`},ae=()=>{L("대시보드");const[m,y]=l.useState(!0),[p,j]=l.useState({}),[f,k]=l.useState({}),[x,S]=l.useState(!1),v=l.useMemo(()=>R(Q(),"asia-northeast3"),[]),P=l.useMemo(()=>G(v,"addStockAndProcessWaitlist"),[v]),I=async()=>{y(!0);try{const[r,t]=await Promise.all([A(!1,9999),O(V(z(H,"orders"),K("status","in",["RESERVED","PREPAID"])))]),d=new Map,i=new Map;t.forEach(a=>{const c=a.data();(c.items||[]).forEach(s=>{const o=`${s.productId}-${s.roundId}-${s.variantGroupId}`;if(c.status==="RESERVED"&&c.wasPrepaymentRequired){const h=i.get(o)||0;i.set(o,h+s.quantity)}else{const h=d.get(o)||0;d.set(o,h+s.quantity)}})});const u=[];r.products.forEach(a=>{const c=a.createdAt&&"toDate"in a.createdAt?Y(a.createdAt.toDate()):"날짜 없음";a.salesHistory?.forEach(s=>{s.variantGroups?.forEach(o=>{const h=o.id||`${a.id}-${s.roundId}-${o.groupName}`,N=`${a.id}-${s.roundId}-${h}`,$=o.totalPhysicalStock??-1,w=$!==-1,C=o.items?.[0]?.stock??-1,M=w?$:C;u.push({id:N,productId:a.id,productName:a.groupName,roundId:s.roundId,roundName:s.roundName,variantGroupId:h,variantGroupName:o.groupName,uploadDate:c,confirmedReservedQuantity:d.get(N)||0,pendingPrepaymentQuantity:i.get(N)||0,waitlistedQuantity:s.waitlistCount||0,configuredStock:M})})})});const n=u.reduce((a,c)=>{const s=c.uploadDate;return a[s]||(a[s]=[]),a[s].push(c),a},{});j(n)}catch(r){console.error("대시보드 데이터를 불러오는 중 오류 발생:",r),g.error("데이터를 불러오는 데 실패했습니다.")}finally{y(!1)}};l.useEffect(()=>{I()},[]);const b=l.useMemo(()=>Object.keys(p).sort((r,t)=>t.localeCompare(r)),[p]),E=(r,t)=>{k(d=>({...d,[r]:t}))},D=async()=>{if(Object.keys(f).length===0){g.error("변경된 내용이 없습니다.");return}S(!0);const r=Object.values(p).flat();let t=!1;const d=Object.entries(f).map(async([i,u])=>{const n=r.find(s=>s.id===i);if(!n||u.trim()==="")return;const a=parseInt(u,10);if(isNaN(a)||a<0)return g.error(`'${n.productName}'의 재고 값이 올바르지 않습니다.`),t=!0,Promise.resolve();const c=n.configuredStock!==-1?a-n.configuredStock:0;if(c>0){const s={productId:n.productId,roundId:n.roundId,variantGroupId:n.variantGroupId,additionalStock:c};return P(s).catch(o=>{console.error(`'${n.productName}' 대기열 처리 실패:`,o),g.error(`'${n.productName}' 처리 중 오류: ${o.message}`),t=!0})}return Promise.resolve()});await g.promise(Promise.all(d),{loading:"재고 변경 및 대기열 처리 중...",success:"모든 변경 작업이 완료되었습니다.",error:"저장 작업 중 예기치 않은 오류가 발생했습니다."}),S(!1),k({}),t||I()};return m?e.jsx(q,{}):e.jsxs("div",{className:"dashboard-container",children:[e.jsxs("div",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-title-area",children:[e.jsx(T,{size:28}),e.jsx("h1",{children:"통합 판매 현황 대시보드"})]}),e.jsxs("button",{className:"bulk-save-button",onClick:D,disabled:Object.keys(f).length===0||x,children:[e.jsx(U,{size:18}),x?"저장 중...":"모든 변경사항 저장"]})]}),b.length>0?b.map(r=>e.jsxs("div",{className:"dashboard-group",children:[e.jsxs("h2",{className:"group-title",children:[r," 업로드 상품"]}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"dashboard-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"No."}),e.jsx("th",{children:"상품명"}),e.jsx("th",{children:"판매 회차"}),e.jsxs("th",{className:"wait-col",children:[e.jsx(F,{size:14})," 선입금 대기"]}),e.jsxs("th",{className:"reserve-col",children:[e.jsx(W,{size:14})," 확정 수량"]}),e.jsx("th",{children:"대기 수량"}),e.jsx("th",{children:"남은 수량"}),e.jsx("th",{children:"설정된 재고"}),e.jsx("th",{children:"최종 재고 입력"})]})}),e.jsx("tbody",{children:p[r].map((t,d)=>{const i=t.configuredStock===-1?-1:t.configuredStock-t.confirmedReservedQuantity,u=t.productName===t.variantGroupName?t.productName:`${t.productName} - ${t.variantGroupName}`;return e.jsxs("tr",{children:[e.jsx("td",{children:d+1}),e.jsx("td",{className:"product-name-cell",children:u}),e.jsx("td",{children:t.roundName}),e.jsx("td",{className:"quantity-cell wait-col",children:t.pendingPrepaymentQuantity>0?t.pendingPrepaymentQuantity:"-"}),e.jsx("td",{className:"quantity-cell reserve-col",children:t.confirmedReservedQuantity}),e.jsx("td",{className:"quantity-cell",children:t.waitlistedQuantity>0?t.waitlistedQuantity:"-"}),e.jsx("td",{className:"quantity-cell important-cell",children:i===-1?e.jsx("span",{className:"unlimited-stock",children:"무제한"}):`${i}`}),e.jsx("td",{className:"quantity-cell",children:t.configuredStock===-1?e.jsx("span",{className:"unlimited-stock",children:"무제한"}):`${t.configuredStock}`}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"final-stock-input",placeholder:"발주량 입력",value:f[t.id]||"",onChange:n=>E(t.id,n.target.value),disabled:x})})]},t.id)})})]})})]},r)):e.jsx("p",{className:"no-data-message",children:"표시할 상품 데이터가 없습니다."})]})};export{ae as default};
