import{r as s,R as de,j as t,u as Re,a as De,d as Me,b as ke,f as Le,g as _e,V as I,h as Ie,i as Te,k as Ae,l as Pe,m as Oe,n as Ye,S as ze}from"./index-BMz7zIRN.js";import{I as $e}from"./InlineSodomallLoader-CN_E-RXV.js";import{C as Ue}from"./clock-D_nK6rhO.js";import{C as we}from"./chevron-left-DTstWtwR.js";import{C as fe}from"./chevron-right-BbSiuQEu.js";import{g as le}from"./imageUtils-BPiZeTFW.js";import{r as Be,d as M}from"./dayjs.min-B5lyAaGD.js";import{u as Ve}from"./useLongPress-C3c2NboI.js";import{s as Ee,d as Fe,g as He,a as We,b as pe}from"./productUtils-BZ5ruf3w.js";import{S as ge}from"./shield-x-DqlWjWof.js";import{C as ve}from"./calendar-B4F1rzMj.js";import{c as me}from"./createLucideIcon-Df3tO_ja.js";import{H as xe}from"./hourglass-Cbw8WS9u.js";import{S as Ge}from"./star-DZq8jtrE.js";import{C as be}from"./check-6pj1M3ks.js";import{S as qe}from"./shopping-cart-DDLkxA9X.js";import{M as Qe}from"./minus-CdiIzwb3.js";import{P as Ke}from"./plus-Q3suSHkb.js";import{i as Xe}from"./isBetween-CLbg94Zy.js";import{s as Je}from"./toastUtils-C4esVHua.js";import{R as Ze}from"./refresh-cw-rA7dvjEr.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],tt=me("arrow-down",et);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]],rt=me("flame",st);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=[["path",{d:"M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14",key:"e7tb2h"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["line",{x1:"12",x2:"12",y1:"22",y2:"12",key:"a4e8g8"}],["circle",{cx:"18.5",cy:"15.5",r:"2.5",key:"b5zd12"}],["path",{d:"M20.27 17.27 22 19",key:"1l4muz"}]],at=me("package-search",nt),ot=()=>{const e=s.useRef(null),[l,c]=s.useState(!1),[r,f]=s.useState(0),[n,a]=s.useState(0),[h,d]=s.useState(!1),[u,m]=s.useState(!1),i=s.useCallback(()=>{const p=e.current;if(!p)return;p.scrollWidth>p.clientWidth?(d(p.scrollLeft>1),m(p.scrollLeft<p.scrollWidth-p.clientWidth-1)):(d(!1),m(!1))},[]);s.useEffect(()=>{const p=e.current;if(!p)return;const w=setTimeout(i,100);p.addEventListener("scroll",i);const S=new ResizeObserver(i);S.observe(p);const v=new MutationObserver(i);return v.observe(p,{childList:!0,subtree:!0}),()=>{clearTimeout(w),p.removeEventListener("scroll",i),S.disconnect(),v.disconnect()}},[i]);const j=s.useCallback(p=>{e.current&&(c(!0),f(p.pageX-e.current.offsetLeft),a(e.current.scrollLeft),e.current.style.cursor="grabbing")},[]),k=s.useCallback(()=>{c(!1),e.current&&(e.current.style.cursor="grab")},[]),D=s.useCallback(p=>{if(!l||!e.current)return;p.preventDefault();const S=p.pageX-e.current.offsetLeft-r;e.current.scrollLeft=n-S},[l,r,n]),E=s.useCallback(p=>{if(e.current){const w=e.current,S=w.clientWidth*.8;w.scrollBy({left:p==="right"?S:-S,behavior:"smooth"})}},[]);return{scrollRef:e,mouseHandlers:{onMouseDown:j,onMouseLeave:k,onMouseUp:k,onMouseMove:D},scrollByPage:E,showLeftArrow:h,showRightArrow:u}},ae=({icon:e,title:l,children:c,countdownText:r,tutorialId:f})=>{const{scrollRef:n,mouseHandlers:a,scrollByPage:h,showLeftArrow:d,showRightArrow:u}=ot(),m=de.Children.toArray(c),i=m.length>0&&m.some(j=>j!==null);return t.jsxs("section",{className:"page-section product-section","data-tutorial-id":f,children:[t.jsxs("div",{className:"section-header",children:[t.jsxs("h2",{className:"section-title",children:[e,l]}),r&&t.jsxs("div",{className:"section-countdown",children:[t.jsx(Ue,{size:14,className:"countdown-icon"}),t.jsx("span",{children:"마감"}),t.jsx("span",{className:"countdown-time",children:r})]})]}),t.jsxs("div",{className:"horizontal-scroll-container",children:[t.jsx("button",{className:`scroll-arrow prev ${d?"visible":""}`,onClick:()=>h("left"),"aria-label":"이전 상품 보기",children:t.jsx(we,{})}),t.jsx("div",{className:"product-grid horizontal-scroll",ref:n,...a,children:i?c:null}),t.jsx("button",{className:`scroll-arrow next ${u?"visible":""}`,onClick:()=>h("right"),"aria-label":"다음 상품 보기",children:t.jsx(fe,{})})]})]})},oe="https://placeholder.com/1200x400.png?text=Banner",ye=e=>{if(!e)return!1;try{return new URL(e).hostname.includes("firebasestorage.googleapis.com")}catch{return!1}},it=({src:e,alt:l,eager:c})=>{const r=e&&e.trim()?e:oe,f=de.useMemo(()=>ye(r)?r:le(r,"1080x1080")||r,[r]),[n,a]=s.useState(f);s.useEffect(()=>{if(ye(r))a(r);else{const d=le(r,"1080x1080")||r;a(d)}},[r]);const h=s.useCallback(()=>{n!==r?a(r):n!==oe&&a(oe)},[n,r]);return t.jsx("img",{src:n,alt:l,loading:c?"eager":"lazy",fetchpriority:c?"high":"auto",onError:h})},ct=({banners:e,className:l})=>{const[c,r]=s.useState(0),f=s.useRef(null),n=s.useRef(null),a=s.useCallback(()=>{r(u=>u===e.length-1?0:u+1)},[e.length]),h=s.useCallback(()=>{r(u=>u===0?e.length-1:u-1)},[e.length]),d=s.useCallback(()=>{n.current&&clearInterval(n.current),e.length>1&&(n.current=setInterval(a,5e3))},[e.length,a]);return s.useEffect(()=>(d(),()=>{n.current&&clearInterval(n.current)}),[d]),s.useEffect(()=>{f.current&&(f.current.style.transform=`translateX(-${c*100}%)`)},[c]),s.useEffect(()=>{r(0),d()},[e,d]),!e||e.length===0?t.jsx("div",{className:`banner-slider-container ${l||""}`,children:t.jsx("div",{className:"banner-slide-placeholder",children:"배너가 없습니다."})}):t.jsxs("div",{className:`banner-slider-container ${l||""}`,children:[t.jsx("div",{className:"banner-slider-wrapper",ref:f,children:e.map((u,m)=>t.jsx("a",{href:u.linkTo||"#",target:u.linkTo?.startsWith("http")?"_blank":"_self",rel:"noopener noreferrer",className:"banner-slide","aria-label":`배너 ${m+1}`,children:t.jsx(it,{src:u.imageUrl,alt:`Banner ${m+1}`,eager:m===0})},u.id))}),e.length>1&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"banner-nav-button prev",onClick:h,"aria-label":"이전 배너",children:t.jsx(we,{size:24})}),t.jsx("button",{className:"banner-nav-button next",onClick:a,"aria-label":"다음 배너",children:t.jsx(fe,{size:24})}),t.jsx("div",{className:"banner-dots-container",children:e.map((u,m)=>t.jsx("button",{className:`banner-dot ${m===c?"active":""}`,onClick:()=>r(m),"aria-label":`배너 ${m+1}로 이동`},m))})]})]})};var Z={exports:{}},lt=Z.exports,je;function ut(){return je||(je=1,function(e,l){(function(c,r){e.exports=r(Be())})(lt,function(c){function r(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var f=r(c),n={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(a){return a+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(a){return a<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return f.default.locale(n,null,!0),n})}(Z)),Z.exports}ut();const Se=({quantity:e,onUpdate:l,max:c})=>{const[r,f]=s.useState(e.toString()),n=s.useRef(null);s.useEffect(()=>{f(e.toString())},[e]);const a=s.useCallback(()=>{const i=parseInt(r,10),j=!isNaN(i)&&i>0?Math.min(i,c):1;j!==e&&l(j)},[r,e,c,l]),h=i=>{i.key==="Enter"&&(i.preventDefault(),a(),n.current?.blur())},d=i=>{const j=()=>{const k=e+i;k>=1&&k<=c&&l(k)};return Ve(j,j,{delay:100})},u=d(-1),m=d(1);return t.jsxs("div",{className:"quantity-controls",children:[t.jsx("button",{...u,className:"quantity-btn",disabled:e<=1,children:t.jsx(Qe,{size:16})}),t.jsx("input",{ref:n,type:"number",className:"quantity-input",value:r,onChange:i=>f(i.target.value),onBlur:a,onKeyDown:h}),t.jsx("button",{...m,className:"quantity-btn",disabled:e>=c,children:t.jsx(Ke,{size:16})})]})},H="https://placeholder.com/200x200.png?text=No+Image",dt=e=>{try{return new URL(e).hostname.includes("firebasestorage.googleapis.com")}catch{return!1}},ft=({product:e})=>{const l=Re(),c=De(),{addToCart:r}=Me(),{isSuspendedUser:f,userDocument:n}=ke(),{hasRequestedEncore:a,requestEncore:h,loading:d}=Le(),{isPreLaunch:u,launchDate:m}=_e(),[i,j]=s.useState(1),[k,D]=s.useState(!1),E=s.useRef(null),[p,w]=s.useState(H);s.useEffect(()=>{const x=e.imageUrls?.find(b=>typeof b=="string"&&b.trim()!=="")||H;if(dt(x)){w(x);return}const g=le(x,"200x200")||x;w(g)},[e.imageUrls]);const S=s.useCallback(()=>{const x=e.imageUrls?.find(g=>typeof g=="string"&&g.trim()!=="")||H;p!==x?w(x):p!==H&&w(H)},[p,e.imageUrls]);s.useEffect(()=>()=>{E.current&&clearTimeout(E.current)},[]);const v=s.useMemo(()=>{const{displayRound:x}=e;if(!x)return null;const g=(x.variantGroups?.length??0)>1||(x.variantGroups?.[0]?.items?.length??0)>1,b=g?void 0:x.variantGroups?.[0],o=b?.items?.[0]||null;return{displayRound:x,isMultiOption:g,singleOptionItem:o,singleOptionVg:b,price:o?.price??x.variantGroups?.[0]?.items?.[0]?.price??0,pickupDateFormatted:M(Ee(x.pickupDate)).locale("ko").format("M/D(ddd)"),storageType:e.storageType}},[e]),A=s.useMemo(()=>{if(!v)return"ENDED";const{displayRound:x,isMultiOption:g,singleOptionVg:b}=v,o=Fe(x,n,b);return o==="PURCHASABLE"&&g?"REQUIRE_OPTION":o},[v,n]),T=s.useCallback(()=>{if(f){I.error("반복적인 약속 불이행으로 공동구매 참여가 제한되었습니다.");return}e.id&&l(`/product/${e.id}`,{state:{background:c}})},[l,e.id,c,f]),W=s.useCallback(x=>{if(x.stopPropagation(),u){I(`🛍️ 상품 예약은 ${M(m).format("M/D")} 정식 런칭 후 가능해요!`,{icon:"🗓️"});return}if(!v||!v.singleOptionItem||k)return;if(f){I.error("반복적인 약속 불이행으로 공동구매 참여가 제한되었습니다.");return}const{displayRound:g,singleOptionItem:b,singleOptionVg:o}=v,N=o?.reservedCount||0,y=o?.totalPhysicalStock,C=y===null||y===-1?1/0:(y||0)-N;if(i*(b.stockDeductionAmount||1)>C){I.error("재고가 부족합니다.");return}const L={id:`reservation-${e.id}-${b.id}-${Date.now()}`,stockDeductionAmount:b.stockDeductionAmount||1,productId:e.id,productName:e.groupName,imageUrl:e.imageUrls?.[0]||"",roundId:g.roundId,roundName:g.roundName,variantGroupId:o?.id||"",variantGroupName:o?.groupName||"",itemId:b.id||"",itemName:b.name,quantity:i,unitPrice:b.price,stock:b.stock,pickupDate:g.pickupDate,status:"RESERVATION",deadlineDate:g.deadlineDate,isPrepaymentRequired:g.isPrepaymentRequired??!1};r(L),I.success(`${e.groupName} ${i}개를 담았어요!`,{duration:3e3}),j(1),E.current&&clearTimeout(E.current),D(!0),E.current=setTimeout(()=>D(!1),1500)},[e,i,v,r,k,f,u,m]),ee=s.useCallback(x=>{if(x.stopPropagation(),u){I(`🛍️ 대기 신청은 ${M(m).format("M/D")} 정식 런칭 후 가능해요!`,{icon:"🗓️"});return}if(!v||!v.singleOptionItem||k)return;if(f){I.error("반복적인 약속 불이행으로 공동구매 참여가 제한되었습니다.");return}const{displayRound:g,singleOptionItem:b,singleOptionVg:o}=v,N={id:`waitlist-${e.id}-${b.id}-${Date.now()}`,stockDeductionAmount:b.stockDeductionAmount||1,productId:e.id,productName:e.groupName,imageUrl:e.imageUrls?.[0]||"",roundId:g.roundId,roundName:g.roundName,variantGroupId:o?.id||"",variantGroupName:o?.groupName||"",itemId:b.id||"",itemName:b.name,quantity:i,unitPrice:b.price,stock:-1,pickupDate:g.pickupDate,status:"WAITLIST",deadlineDate:g.deadlineDate,isPrepaymentRequired:!1};r(N),I.success(`${e.groupName} ${i}개를 대기 목록에 추가했습니다.`,{duration:3e3}),j(1),E.current&&clearTimeout(E.current),D(!0),E.current=setTimeout(()=>D(!1),1500)},[e,i,v,r,k,f,u,m]),G=s.useCallback(x=>{if(x.stopPropagation(),!n){I.error("로그인이 필요합니다.");return}if(a(e.id)){I("이미 앵콜을 요청한 상품입니다!",{icon:"🙌"});return}const g=h(e.id);I.promise(g,{loading:"앵콜 요청 중...",success:"앵콜 요청이 접수되었습니다!",error:"오류가 발생했습니다."})},[n,e.id,h,a]);if(!v)return null;const{pickupDateFormatted:P,storageType:te}=v,$=(x=>{switch(x){case"FROZEN":return{label:"냉동",style:{backgroundColor:"#5c7cfa",color:"#fff"}};case"COLD":return{label:"냉장",style:{backgroundColor:"#e63946",color:"#fff"}};case"ROOM":return{label:"실온",style:{backgroundColor:"#212529",color:"#fff"}};default:return null}})(te),q=()=>{if(u)return t.jsxs("button",{className:"options-btn",onClick:T,children:[t.jsx(ve,{size:16})," ",M(m).format("M월 D일")," 오픈!"]});if(f)return t.jsxs("div",{className:"options-btn disabled",children:[t.jsx(ge,{size:16})," 참여 제한"]});switch(A){case"PURCHASABLE":const x=v.singleOptionVg?.reservedCount||0,g=v.singleOptionVg?.totalPhysicalStock,b=g===null||g===-1?1/0:(g||0)-x,o=Math.floor(b/(v.singleOptionItem?.stockDeductionAmount||1));return t.jsxs("div",{className:"action-controls",onClick:C=>C.stopPropagation(),children:[t.jsx(Se,{quantity:i,onUpdate:j,max:o}),k?t.jsxs("button",{className:"add-to-cart-btn just-added",disabled:!0,children:[t.jsx(be,{size:18})," 담았어요"]}):t.jsxs("button",{className:"add-to-cart-btn",onClick:W,children:[t.jsx(qe,{size:16})," 담기"]})]});case"WAITLISTABLE":const N=v.singleOptionItem?.limitQuantity||99;return t.jsxs("div",{className:"action-controls",onClick:C=>C.stopPropagation(),children:[t.jsx(Se,{quantity:i,onUpdate:j,max:N}),k?t.jsxs("button",{className:"waitlist-action-btn just-added",disabled:!0,children:[t.jsx(be,{size:18})," 신청됨"]}):t.jsxs("button",{className:"waitlist-action-btn",onClick:ee,children:[t.jsx(xe,{size:16})," 대기"]})]});case"REQUIRE_OPTION":return t.jsxs("button",{className:"options-btn",onClick:T,children:["옵션 선택하기 ",t.jsx(fe,{size:16})]});case"ENCORE_REQUESTABLE":const y=a(e.id);return t.jsxs("button",{className:`encore-btn ${y?"requested":""}`,onClick:G,disabled:y||d,children:[t.jsx(Ge,{size:16})," ",d?"처리중":y?"요청완료":"앵콜 요청"]});case"AWAITING_STOCK":return t.jsxs("div",{className:"options-btn disabled",children:[t.jsx(xe,{size:16})," 재고 준비중"]});case"ENDED":return t.jsx("div",{className:"options-btn disabled",children:"예약 종료"});case"SCHEDULED":return t.jsx("div",{className:"options-btn disabled",children:"판매 예정"});default:return null}},U=()=>{if(u||A!=="PURCHASABLE"&&A!=="REQUIRE_OPTION")return null;const{isMultiOption:x,singleOptionVg:g,displayRound:b}=v;let o=!1,N="한정수량";if(x)o=b.variantGroups.some(y=>y.totalPhysicalStock!==null&&y.totalPhysicalStock!==-1);else if(g){const y=g.totalPhysicalStock;if(o=y!==null&&y!==-1,o){const C=g.reservedCount||0;N=`${(y||0)-C}개 남음!`}}return o?t.jsxs("div",{className:"card-top-badge",children:[t.jsx(rt,{size:14})," ",N]}):null};return t.jsx("div",{className:"product-card-wrapper",children:t.jsxs("div",{className:"product-card-final",onClick:T,children:[t.jsx(U,{}),t.jsxs("div",{className:"card-image-container",children:[t.jsx("img",{src:p,alt:e.groupName,loading:"lazy",onError:S}),A==="AWAITING_STOCK"&&t.jsx("div",{className:"card-overlay-badge",children:"재고 준비중"}),f&&e.phase!=="past"&&t.jsxs("div",{className:"card-overlay-restricted",children:[t.jsx(ge,{size:32}),t.jsx("p",{children:"참여 제한"})]})]}),t.jsxs("div",{className:"card-content-container",children:[t.jsxs("div",{className:"content-row",children:[t.jsx("h3",{className:"content-title",children:e.groupName}),$&&t.jsx("span",{className:"content-badge",style:$.style,children:$.label})]}),t.jsxs("div",{className:"content-row meta-row",children:[t.jsxs("span",{className:"content-price",children:[v.price.toLocaleString(),"원"]}),t.jsxs("span",{className:"content-pickup",children:[t.jsx(ve,{size:14})," ",P]})]}),t.jsx("div",{className:"content-action-row",children:q()})]})]})})},ie=de.memo(ft);var ue=new Map,J=new WeakMap,Ne=0,mt=void 0;function ht(e){return e?(J.has(e)||(Ne+=1,J.set(e,Ne.toString())),J.get(e)):"0"}function pt(e){return Object.keys(e).sort().filter(l=>e[l]!==void 0).map(l=>`${l}_${l==="root"?ht(e.root):e[l]}`).toString()}function gt(e){const l=pt(e);let c=ue.get(l);if(!c){const r=new Map;let f;const n=new IntersectionObserver(a=>{a.forEach(h=>{var d;const u=h.isIntersecting&&f.some(m=>h.intersectionRatio>=m);e.trackVisibility&&typeof h.isVisible>"u"&&(h.isVisible=u),(d=r.get(h.target))==null||d.forEach(m=>{m(u,h)})})},e);f=n.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),c={id:l,observer:n,elements:r},ue.set(l,c)}return c}function vt(e,l,c={},r=mt){if(typeof window.IntersectionObserver>"u"&&r!==void 0){const d=e.getBoundingClientRect();return l(r,{isIntersecting:r,target:e,intersectionRatio:typeof c.threshold=="number"?c.threshold:0,time:0,boundingClientRect:d,intersectionRect:d,rootBounds:d}),()=>{}}const{id:f,observer:n,elements:a}=gt(c),h=a.get(e)||[];return a.has(e)||a.set(e,h),h.push(l),n.observe(e),function(){h.splice(h.indexOf(l),1),h.length===0&&(a.delete(e),n.unobserve(e)),a.size===0&&(n.disconnect(),ue.delete(f))}}function xt({threshold:e,delay:l,trackVisibility:c,rootMargin:r,root:f,triggerOnce:n,skip:a,initialInView:h,fallbackInView:d,onChange:u}={}){var m;const[i,j]=s.useState(null),k=s.useRef(u),[D,E]=s.useState({inView:!!h,entry:void 0});k.current=u,s.useEffect(()=>{if(a||!i)return;let v;return v=vt(i,(A,T)=>{E({inView:A,entry:T}),k.current&&k.current(A,T),T.isIntersecting&&n&&v&&(v(),v=void 0)},{root:f,rootMargin:r,threshold:e,trackVisibility:c,delay:l},d),()=>{v&&v()}},[Array.isArray(e)?e.toString():e,i,f,r,n,a,c,d,l]);const p=(m=D.entry)==null?void 0:m.target,w=s.useRef(void 0);!i&&p&&!n&&!a&&w.current!==p&&(w.current=p,E({inView:!!h,entry:void 0}));const S=[j,D.inView,D.entry];return S.ref=S[0],S.inView=S[1],S.entry=S[2],S}const ce=80,bt=110,yt=({onRefresh:e})=>{const[l,c]=s.useState(0),[r,f]=s.useState(!1),[n,a]=s.useState(!1),h=s.useRef(0),d=s.useRef(!1),u=s.useCallback(j=>{window.scrollY===0&&j.touches[0]&&(h.current=j.touches[0].clientY,d.current=!0)},[]),m=s.useCallback(j=>{if(!d.current||!j.touches[0])return;const D=j.touches[0].clientY-h.current;if(D>0){window.scrollY===0&&j.preventDefault();const E=Math.min(bt,ce+(D-ce)*.4);c(E),a(E>ce+5)}},[]),i=s.useCallback(async()=>{d.current&&(d.current=!1,n&&(f(!0),await e(),f(!1)),c(0),a(!1))},[n,e]);return s.useEffect(()=>(window.addEventListener("touchstart",u),window.addEventListener("touchmove",m,{passive:!1}),window.addEventListener("touchend",i),()=>{window.removeEventListener("touchstart",u),window.removeEventListener("touchmove",m),window.removeEventListener("touchend",i)}),[u,m,i]),{pullDistance:l,isRefreshing:r,isThresholdReached:n}};M.extend(Xe);M.locale("ko");const Bt=()=>{const{userDocument:e}=ke(),{startTour:l,isTourRunning:c}=Ie(),[r,f]=s.useState([]),[n,a]=s.useState([]),[h,d]=s.useState(null),[u,m]=s.useState(!0),[i,j]=s.useState(!1),[k,D]=s.useState(null),E=10,p=s.useRef(null),w=s.useRef(!0),S=s.useRef(!1),v=s.useRef(0),A=800,T=s.useMemo(()=>Te(Ae(),"asia-northeast3"),[]),W=s.useMemo(()=>Pe(T,"getProductsWithStock"),[T]),{ref:ee,inView:G}=xt({threshold:0,triggerOnce:!1});s.useEffect(()=>{e&&!e.hasCompletedTutorial&&setTimeout(()=>l(Oe),500)},[e,l]);const P=s.useCallback(async(o=!1)=>{if(S.current)return;if(S.current=!0,o)m(!0),D(null),p.current=null,w.current=!0;else{if(!w.current){S.current=!1;return}j(!0)}const N=p.current;try{if(o){const B=await Ye();f(B)}const y=await W({pageSize:E,lastVisible:p.current}),{products:C,lastVisible:L}=y.data;a(B=>{const V=new Map(B.map(Y=>[Y.id,Y]));return(C||[]).forEach(Y=>V.set(Y.id,Y)),o?C||[]:Array.from(V.values())}),p.current=L;const O=L===null||L===N||(C?.length??0)===0||(C?.length??0)<E;w.current=!O}catch(y){D("상품을 불러오는 중 오류가 발생했습니다."),Je("error",y?.message||"데이터 로딩 중 문제가 발생했습니다."),w.current=!1}finally{o&&m(!1),j(!1),S.current=!1,v.current=Date.now()}},[W]),te=s.useCallback(async()=>{await P(!0)},[P]),{pullDistance:se,isRefreshing:$,isThresholdReached:q}=yt({onRefresh:te});s.useEffect(()=>{P(!0)},[P]),s.useEffect(()=>{!G||u||i||c||!w.current||S.current||Date.now()-v.current<A||P(!1)},[G,u,i,c,P]);const{primarySaleProducts:U,secondarySaleProducts:x,pastProductsByDate:g,primarySaleEndDate:b}=s.useMemo(()=>{const o=M(),N=e?.loyaltyTier,y=[],C=[],L=[];n.forEach(_=>{const R=He(_);if(!R||R.status==="draft")return;const Q=R.allowedTiers||[];if(Q.length>0&&(!N||!Q.includes(N)))return;const{primaryEnd:K,secondaryEnd:F}=We(R);if(!K)return;let z;if(o.isBefore(M(K))?z="primary":F&&o.isBetween(M(K),M(F),null,"[]")?z="secondary":z="past",R.status==="scheduled"&&R.publishAt){const ne=Ee(R.publishAt);if(ne&&o.isBefore(ne))return}const re={..._,phase:z,deadlines:{primaryEnd:K,secondaryEnd:F},displayRound:R};z==="primary"?y.push(re):z==="secondary"?R.variantGroups.every(he=>{const X=he.totalPhysicalStock;if(X===null||X===-1)return!1;if(X===0)return!0;const Ce=he.reservedCount||0;return X-Ce<=0})||C.push(re):F&&o.diff(M(F),"day")<=7&&L.push(re)});const O={};L.forEach(_=>{if(_.deadlines.secondaryEnd){const R=M(_.deadlines.secondaryEnd).format("YYYY-MM-DD");O[R]||(O[R]=[]),O[R].push(_)}});const B=Object.keys(O).sort((_,R)=>R.localeCompare(_)),V={};B.forEach(_=>{V[_]=O[_].sort((R,Q)=>(R.displayRound.roundName||"").localeCompare(Q.displayRound.roundName||""))});const Y=y.length>0?y[0].deadlines.primaryEnd:null;return{primarySaleProducts:y.sort(pe),secondarySaleProducts:C.sort(pe),pastProductsByDate:V,primarySaleEndDate:Y}},[n,e]);return s.useEffect(()=>{if(!b){d(null);return}const o=setInterval(()=>{const N=M(b).diff(M(),"second");if(N<=0){d("마감!"),clearInterval(o);return}const y=String(Math.floor(N/3600)).padStart(2,"0"),C=String(Math.floor(N%3600/60)).padStart(2,"0"),L=String(N%60).padStart(2,"0");d(`${y}:${C}:${L}`)},1e3);return()=>clearInterval(o)},[b]),u&&n.length===0?t.jsx(ze,{}):k?t.jsx("div",{className:"error-message-container",children:k}):t.jsxs("div",{className:"customer-page-container",children:[t.jsx("div",{className:"pull-to-refresh-indicator",style:{height:`${se}px`},children:t.jsx("div",{className:"indicator-content",children:$?t.jsx(Ze,{size:24,className:"refreshing-icon"}):t.jsxs(t.Fragment,{children:[t.jsx(tt,{size:20,className:"arrow-icon",style:{transform:q?"rotate(180deg)":"rotate(0deg)"}}),t.jsx("span",{children:q?"놓아서 새로고침":"아래로 당겨서 새로고침"})]})})}),t.jsxs("div",{className:"pull-to-refresh-content",style:{transform:`translateY(${se}px)`},children:[t.jsx("div",{className:"page-section banner-section","data-tutorial-id":"main-banner",children:t.jsx(ct,{banners:r})}),t.jsx(ae,{title:t.jsx(t.Fragment,{children:"🔥 오늘의 공동구매"}),countdownText:U.length>0?h:null,tutorialId:"primary-sale-section",children:U.length>0?U.map(o=>t.jsx(ie,{product:o},o.id)):!u&&t.jsxs("div",{className:"product-list-placeholder",children:[t.jsx(at,{size:48}),t.jsx("p",{children:"오늘의 상품을 준비중입니다"}),t.jsx("span",{children:"매일 오후 1시에 새로운 상품을 기대해주세요!"})]})},"primary-section"),x.length>0&&t.jsx(ae,{title:t.jsx(t.Fragment,{children:"⏰ 마감임박! 추가공구"}),tutorialId:"secondary-sale-section",children:x.map(o=>t.jsx(ie,{product:o},o.id))},"secondary-section"),t.jsx("div",{className:"past-products-section","data-tutorial-id":"past-sale-section",children:Object.keys(g).map(o=>{const N=g[o];return!N||N.length===0?null:t.jsx(ae,{title:t.jsxs(t.Fragment,{children:[M(o).format("M월 D일 (dddd)")," 마감 공구"]}),children:N.map(y=>t.jsx(ie,{product:y},y.id))},o)})}),t.jsxs("div",{ref:ee,className:"infinite-scroll-loader",children:[i&&t.jsx($e,{}),!w.current&&n.length>E&&t.jsx("div",{className:"end-of-list-message",children:t.jsx("p",{children:"모든 상품을 확인했어요!"})})]})]})]})};export{Bt as default};
