import{r as l,u as me,i as xe,k as je,l as ge,a4 as Ee,a0 as ae,a1 as re,a2 as ie,C as oe,a3 as Te,V as k,j as e,S as Ge,T as ze,a5 as qe,a6 as Re,R as Le,a7 as Fe,a8 as We}from"./index-BMz7zIRN.js";import{u as Qe}from"./useDocumentTitle-BBAuQihd.js";import{g as Oe}from"./orderService-Bzti28Gn.js";import{I as Ue}from"./InlineSodomallLoader-CN_E-RXV.js";import{d as B}from"./dayjs.min-B5lyAaGD.js";import{i as Ve}from"./isBetween-CLbg94Zy.js";import{f as ce}from"./number-D3CZtsVU.js";import{r as H,a as X}from"./logger-CZyc96rC.js";import{c as Be}from"./createLucideIcon-Df3tO_ja.js";import{P as Y}from"./plus-Q3suSHkb.js";import{C as _e}from"./chart-no-axes-column-CffmgICP.js";import{S as Ke}from"./search-C7k3Fw0J.js";import{F as Je}from"./funnel-wB9N5xOV.js";import{T as de}from"./trash-2-C0X2zetg.js";import{T as He}from"./triangle-alert-DUarG1oM.js";import{S as Z}from"./square-pen-CwtIThVX.js";import{C as Ze}from"./chevron-down-BK2KvEme.js";import{C as Xe}from"./chevrons-left-DkUsVS3s.js";import{C as Ye}from"./chevrons-right-B6gfhwfl.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["path",{d:"M12 22v-9",key:"x3hkom"}],["path",{d:"M15.17 2.21a1.67 1.67 0 0 1 1.63 0L21 4.57a1.93 1.93 0 0 1 0 3.36L8.82 14.79a1.655 1.655 0 0 1-1.64 0L3 12.43a1.93 1.93 0 0 1 0-3.36z",key:"2ntwy6"}],["path",{d:"M20 13v3.87a2.06 2.06 0 0 1-1.11 1.83l-6 3.08a1.93 1.93 0 0 1-1.78 0l-6-3.08A2.06 2.06 0 0 1 4 16.87V13",key:"1pmm1c"}],["path",{d:"M21 12.43a1.93 1.93 0 0 0 0-3.36L8.83 2.2a1.64 1.64 0 0 0-1.63 0L3 4.57a1.93 1.93 0 0 0 0 3.36l12.18 6.86a1.636 1.636 0 0 0 1.63 0z",key:"12ttoo"}]],le=Be("package-open",et);B.extend(Ve);const I=t=>{if(!t)return null;if(t instanceof Date)return isNaN(t.getTime())?null:t;if(typeof t.toDate=="function")return t.toDate();if(typeof t=="object"&&t.seconds!==void 0)return new ze(t.seconds,t.nanoseconds||0).toDate();if(typeof t=="string"){const i=new Date(t);if(!isNaN(i.getTime()))return i}return typeof t=="number"&&isFinite(t)?new Date(t):null},tt=t=>{const i=I(t.publishAt),o=I(t.pickupDate),x=i?B(i).add(1,"day").hour(13).minute(0).second(0):t.deadlineDate?B(I(t.deadlineDate)):null,d=o?B(o).hour(13).minute(0).second(0):null;return{primaryEnd:x,secondaryEnd:d}},ue=(t,i)=>{if(!(i===1/0)&&i<=0)return{text:"매진",className:"sold-out"};const x=B(),{primaryEnd:d,secondaryEnd:b}=tt(t),v=I(t.publishAt),w=I(t.pickupDate),g=I(t.pickupDeadlineDate);if(v&&x.isBefore(v))return{text:"판매예정",className:"scheduled"};if(d&&x.isBefore(d))return{text:"공구예약중",className:"selling"};if(b&&d&&x.isBetween(d,b,null,"[]"))return{text:"추가예약중",className:"late-reservation"};if(w&&g&&x.isBetween(w,g,null,"[]"))return{text:"픽업중/현장판매",className:"pickup"};if(b&&x.isAfter(b)||g&&x.isAfter(g))return{text:"판매종료",className:"ended"};switch(t.status){case"selling":return{text:"공구예약중",className:"selling"};case"scheduled":return{text:"판매예정",className:"scheduled"};case"ended":return{text:"판매종료",className:"ended"};default:return{text:"판매종료",className:"ended"}}},V=t=>{const i=I(t);return!i||!isFinite(i.getTime())?"–":i.toLocaleDateString("ko-KR",{year:"2-digit",month:"2-digit",day:"2-digit"}).replace(/\.$/,"")},pe=t=>{const i=I(t);return!i||!isFinite(i.getTime())?"–":`${(i.getMonth()+1).toString().padStart(2,"0")}/${i.getDate().toString().padStart(2,"0")}`},st=t=>t.toDate().toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),K=t=>{const i=t.items.map(o=>o.expirationDate?I(o.expirationDate)?.getTime():void 0).filter(o=>o!=null);return i.length>0?Math.min(...i):1/0},he=t=>({ROOM:"실온",COLD:"냉장",FROZEN:"냉동"})[t]||t;function Q(t,i){const[o,x]=l.useState(()=>{try{const d=localStorage.getItem(t);return d?JSON.parse(d):i}catch(d){return X("usePersistentState.readFail",`key=${t}`,{error:String(d)}),i}});return l.useEffect(()=>{try{localStorage.setItem(t,JSON.stringify(o))}catch(d){X("usePersistentState.writeFail",`key=${t}`,{error:String(d)})}},[t,o]),[o,x]}const nt=({currentPage:t,totalPages:i,onPageChange:o,itemsPerPage:x,onItemsPerPageChange:d,totalItems:b})=>b===0?null:e.jsxs("div",{className:"pagination-container",children:[e.jsx("div",{className:"pagination-left",children:e.jsxs("div",{className:"items-per-page-selector",children:[e.jsx("label",{htmlFor:"itemsPerPage",children:"표시 개수:"}),e.jsxs("select",{id:"itemsPerPage",value:x,onChange:d,children:[e.jsx("option",{value:10,children:"10개"}),e.jsx("option",{value:20,children:"20개"}),e.jsx("option",{value:50,children:"50개"}),e.jsx("option",{value:100,children:"100개"})]})]})}),e.jsxs("div",{className:"pagination-center",children:[e.jsx("button",{onClick:()=>o(1),disabled:t===1,title:"첫 페이지",children:e.jsx(Xe,{size:16})}),e.jsx("button",{onClick:()=>o(t-1),disabled:t===1,children:"이전"}),e.jsxs("span",{className:"page-info",children:[t," / ",i]}),e.jsx("button",{onClick:()=>o(t+1),disabled:t===i,children:"다음"}),e.jsx("button",{onClick:()=>o(i),disabled:t===i,title:"마지막 페이지",children:e.jsx(Ye,{size:16})})]}),e.jsx("div",{className:"pagination-right",children:e.jsxs("span",{className:"total-items-display",children:["총 ",b,"개 회차"]})})]}),at=({item:t,index:i,isExpanded:o,isSelected:x,editingStockId:d,stockInputs:b,onToggleExpansion:v,onSelectionChange:w,onStockEditStart:g,onStockEditSave:$,onSetStockInputs:P,onOpenWaitlistModal:z})=>{const D=me(),q=()=>D("/admin/products/add",{state:{productId:t.productId,productGroupName:t.productName,lastRound:t.round}});if(!t.enrichedVariantGroups||t.enrichedVariantGroups.length===0)return e.jsxs("tr",{className:"master-row error-row",children:[e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:x,onChange:r=>w(t.uniqueId,r.target.checked)})}),e.jsx("td",{children:i+1}),e.jsxs("td",{colSpan:12,style:{color:"var(--danger-color)"},children:["데이터 오류: 이 회차에 옵션 그룹이 없습니다. (ID: ",t.uniqueId,")"]}),e.jsx("td",{children:e.jsx("div",{className:"action-buttons-wrapper",children:e.jsx("button",{onClick:()=>D(`/admin/products/edit/${t.productId}/${t.round.roundId}`),className:"admin-action-button",children:e.jsx(Z,{size:16})})})})]});if(!(t.enrichedVariantGroups.length>1)){const r=t.enrichedVariantGroups[0],j=r.dynamicStatus,m=`${t.productId}_${t.round.roundId}_${r.id}`;return e.jsxs("tr",{className:"master-row",children:[e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:x,onChange:u=>w(t.uniqueId,u.target.checked)})}),e.jsx("td",{children:i+1}),e.jsx("td",{children:V(t.round.createdAt)}),e.jsx("td",{children:pe(t.round.pickupDate)}),e.jsx("td",{children:t.category}),e.jsx("td",{children:e.jsx("span",{className:`storage-badge storage-${t.storageType}`,children:he(t.storageType)})}),e.jsx("td",{children:e.jsxs("div",{className:"product-name-cell-v2",children:[e.jsx("img",{src:t.productImage,alt:t.productName,className:"product-thumbnail"}),e.jsxs("div",{className:"product-name-text",children:[e.jsx("span",{className:"product-group-name",children:t.productName}),e.jsx("span",{className:"round-name-text",children:t.round.roundName})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${j.className}`,title:`Status: ${j.text}`,children:j.text})}),e.jsx("td",{style:{textAlign:"right"},children:r.items[0]?.price!=null?`${ce(r.items[0].price)} 원`:"–"}),e.jsx("td",{children:V(K(r))}),e.jsxs("td",{className:"quantity-cell",children:[`${r.reservedQuantity} / `,(t.round.waitlistCount??0)>0?e.jsx("button",{className:"waitlist-count-button",onClick:()=>z(t.productId,t.round.roundId,r.id,t.productName,t.round.roundName),children:t.round.waitlistCount??0}):t.round.waitlistCount??0]}),e.jsx("td",{className:"quantity-cell",children:r.pickedUpQuantity}),e.jsx("td",{className:"stock-cell",children:d===m?e.jsx("input",{type:"number",className:"stock-input",value:b[m]||"",onChange:u=>P(E=>({...E,[m]:u.target.value})),onBlur:()=>$(m,t),autoFocus:!0,onKeyDown:u=>{u.key==="Enter"&&$(m,t),u.key==="Escape"&&g("",0)}}):r.configuredStock===-1?e.jsx("button",{className:"stock-display-button unlimited-badge",onClick:()=>g(m,r.configuredStock),title:"재고 수량을 클릭하여 수정",children:"무제한"}):e.jsx("button",{className:"stock-display-button",onClick:()=>g(m,r.configuredStock),title:"재고 수량을 클릭하여 수정",children:r.configuredStock})}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons-wrapper",children:[e.jsx("button",{onClick:()=>D(`/admin/products/edit/${t.productId}/${t.round.roundId}`),className:"admin-action-button",title:"이 판매 회차 정보를 수정합니다.",children:e.jsx(Z,{size:16})}),e.jsx("button",{onClick:q,className:"admin-action-button",title:"이 상품의 새 판매 회차를 추가합니다.",children:e.jsx(Y,{size:16})})]})})]})}const f=l.useMemo(()=>{const r=t.enrichedVariantGroups.flatMap(j=>j.items.map(m=>m.expirationDate?I(m.expirationDate)?.getTime():void 0).filter(Boolean));return r.length>0?Math.min(...r):1/0},[t.enrichedVariantGroups]),S=t.dynamicStatus;return e.jsxs(Le.Fragment,{children:[e.jsxs("tr",{className:"master-row expandable",children:[e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:x,onChange:r=>w(t.uniqueId,r.target.checked)})}),e.jsx("td",{children:e.jsxs("div",{className:"no-and-expander",children:[e.jsx("span",{children:i+1}),e.jsx("button",{className:"expand-button",onClick:()=>v(t.uniqueId),title:o?"하위 항목 접기":"하위 항목 펼치기",children:e.jsx(Ze,{size:20,className:`chevron-icon ${o?"expanded":""}`})})]})}),e.jsx("td",{children:V(t.round.createdAt)}),e.jsx("td",{children:pe(t.round.pickupDate)}),e.jsx("td",{children:t.category}),e.jsx("td",{children:e.jsx("span",{className:`storage-badge storage-${t.storageType}`,children:he(t.storageType)})}),e.jsx("td",{children:e.jsxs("div",{className:"product-name-cell-v2",children:[e.jsx("img",{src:t.productImage,alt:t.productName,className:"product-thumbnail"}),e.jsxs("div",{className:"product-name-text",children:[e.jsx("span",{className:"product-group-name",children:t.productName}),e.jsx("span",{className:"round-name-text",children:t.round.roundName})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${S.className}`,title:`Round Status: ${S.text}`,children:S.text})}),e.jsx("td",{style:{textAlign:"center",color:"var(--text-color-light)"},children:"–"}),e.jsx("td",{children:V(f)}),e.jsx("td",{style:{textAlign:"center",color:"var(--text-color-light)"},children:"–"}),e.jsx("td",{style:{textAlign:"center",color:"var(--text-color-light)"},children:"–"}),e.jsx("td",{style:{textAlign:"center",color:"var(--text-color-light)"},children:"–"}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons-wrapper",children:[e.jsx("button",{onClick:()=>D(`/admin/products/edit/${t.productId}/${t.round.roundId}`),className:"admin-action-button",title:"이 판매 회차 정보를 수정합니다.",children:e.jsx(Z,{size:16})}),e.jsx("button",{onClick:q,className:"admin-action-button",title:"이 상품의 새 판매 회차를 추가합니다.",children:e.jsx(Y,{size:16})})]})})]}),o&&t.enrichedVariantGroups.map((r,j)=>{const m=`${t.productId}_${t.round.roundId}_${r.id}`,u=r.dynamicStatus;return e.jsxs("tr",{className:"detail-row sub-row",children:[e.jsx("td",{}),e.jsx("td",{children:e.jsx("span",{className:"sub-row-no",children:`${i+1}-${j+1}`})}),e.jsx("td",{}),e.jsx("td",{}),e.jsx("td",{}),e.jsx("td",{}),e.jsxs("td",{className:"sub-row-name",children:[" └ ",r.groupName]}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${u.className}`,title:`Status: ${u.text}`,children:u.text})}),e.jsx("td",{style:{textAlign:"right"},children:r.items[0]?.price!=null?`${ce(r.items[0].price)} 원`:"–"}),e.jsx("td",{children:V(K(r))}),e.jsxs("td",{className:"quantity-cell",children:[`${r.reservedQuantity} / `,(t.round.waitlistCount??0)>0?e.jsx("button",{className:"waitlist-count-button",onClick:()=>z(t.productId,t.round.roundId,r.id,t.productName,t.round.roundName),children:t.round.waitlistCount??0}):t.round.waitlistCount??0]}),e.jsx("td",{className:"quantity-cell",children:r.pickedUpQuantity}),e.jsx("td",{className:"stock-cell",children:d===m?e.jsx("input",{type:"number",className:"stock-input",value:b[m]||"",onChange:E=>P(J=>({...J,[m]:E.target.value})),onBlur:()=>$(m,t),autoFocus:!0,onKeyDown:E=>{E.key==="Enter"&&$(m,t),E.key==="Escape"&&g("",0)}}):r.configuredStock===-1?e.jsx("button",{className:"stock-display-button unlimited-badge",onClick:()=>g(m,r.configuredStock),title:"재고 수량을 클릭하여 수정",children:"무제한"}):e.jsx("button",{className:"stock-display-button",onClick:()=>g(m,r.configuredStock),title:"재고 수량을 클릭하여 수정",children:r.configuredStock})}),e.jsx("td",{})]},m)})]})},rt=({isOpen:t,onClose:i,data:o,onSuccess:x})=>{const[d,b]=l.useState([]),[v,w]=l.useState(!1),[g,$]=l.useState(""),[P,z]=l.useState(""),D=xe(je(),"asia-northeast3"),q=l.useMemo(()=>ge(D,"addStockAndProcessWaitlist"),[D]);l.useEffect(()=>{t&&o&&(w(!0),$(""),We(o.productId,o.roundId).then(f=>{const S=f.map((r,j)=>({userId:r.userId||`${r.userName}-${j}`,userName:r.userName,quantity:r.quantity,timestamp:r.timestamp}));b(S)}).catch(()=>$("대기자 명단을 불러오는데 실패했습니다.")).finally(()=>w(!1)))},[t,o]);const M=async()=>{const f=parseInt(P,10);if(!o||isNaN(f)||f<=0){k.error("유효한 재고 수량을 입력하세요.");return}const S={productId:o.productId,roundId:o.roundId,variantGroupId:o.variantGroupId,additionalStock:f},r=q(S);k.promise(r,{loading:"대기자 예약 전환 처리 중...",success:j=>(x(),i(),`${j.data.convertedCount}명이 예약으로 전환되었습니다.`),error:j=>j.message||"처리 중 오류가 발생했습니다."})};return!t||!o?null:e.jsx("div",{className:"waitlist-modal-overlay",onClick:i,children:e.jsxs("div",{className:"waitlist-modal-content",onClick:f=>f.stopPropagation(),children:[e.jsxs("div",{className:"waitlist-modal-header",children:[e.jsxs("h3",{children:['"',o.productName,'" 대기자 명단']}),e.jsxs("span",{children:["(",o.roundName,")"]}),e.jsx("button",{onClick:i,className:"modal-close-button",children:"×"})]}),e.jsxs("div",{className:"waitlist-modal-body",children:[v&&e.jsx("div",{className:"modal-inline-loader",children:e.jsx(Ue,{})}),g&&e.jsx("p",{className:"error-text",children:g}),!v&&!g&&(d.length>0?e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"순번"}),e.jsx("th",{children:"신청자"}),e.jsx("th",{children:"신청수량"}),e.jsx("th",{children:"신청일시"})]})}),e.jsx("tbody",{children:d.map((f,S)=>e.jsxs("tr",{children:[e.jsx("td",{children:S+1}),e.jsx("td",{children:f.userName}),e.jsx("td",{children:f.quantity}),e.jsx("td",{children:st(f.timestamp)})]},f.userId))})]}):e.jsx("p",{children:"이 판매 회차의 대기자가 없습니다."}))]}),e.jsxs("div",{className:"waitlist-modal-footer",children:[e.jsx("input",{type:"number",value:P,onChange:f=>z(f.target.value),placeholder:"추가할 재고 수량",className:"stock-add-input"}),e.jsx("button",{onClick:M,className:"stock-add-confirm-btn",disabled:!P||parseInt(P,10)<=0,children:"재고 추가 및 자동 전환"})]})]})})},It=()=>{Qe("상품 목록 관리");const[t,i]=l.useState(!0),[o,x]=l.useState({allProducts:[],categories:[],reservedQuantitiesMap:new Map,pickedUpQuantitiesMap:new Map}),[d,b]=l.useState(1),[v,w]=Q("adminProductItemsPerPage",20),[g,$]=l.useState({}),[P,z]=l.useState(null),[D,q]=Q("adminProductTab","rounds"),[M,f]=Q("adminProductSearch",""),[S,r]=Q("adminProductCategory","all"),[j,m]=Q("adminProductStatus","all"),[u,E]=Q("adminProductSort",{key:"roundCreatedAt",direction:"desc"}),[J,ee]=l.useState(new Set),[A,O]=l.useState(new Set),[fe,te]=l.useState(!1),[Ne,se]=l.useState(null),ye=me(),ne=xe(je(),"asia-northeast3"),ke=l.useMemo(()=>ge(ne,"addStockAndProcessWaitlist"),[ne]),R=l.useCallback(async()=>{i(!0);try{const[s,n,a,c]=await Promise.all([Ee(),Oe(),ae(re(ie(oe,"orders"),Te("status","==","PICKED_UP"))),ae(re(ie(oe,"products")))]),p=c.docs.map(N=>({...N.data(),id:N.id})),h=new Map;a.forEach(N=>{(N.data().items||[]).forEach(y=>{const T=`${y.productId}-${y.roundId}-${y.variantGroupId}`;h.set(T,(h.get(T)||0)+y.quantity)})}),x({allProducts:p,categories:s,reservedQuantitiesMap:n,pickedUpQuantitiesMap:h})}catch(s){H("ProductListPageAdmin.fetchData",s),k.error("데이터를 불러오는 중 오류가 발생했습니다.")}finally{i(!1)}},[]);l.useEffect(()=>{R()},[R]);const L=l.useMemo(()=>{let s=[];return(o.allProducts||[]).forEach(n=>{(n.salesHistory||[]).forEach(a=>{if(!a.variantGroups||a.variantGroups.length===0){X("ProductListPageAdmin.dataAnomaly","옵션 그룹 없음",{productId:n.id,roundId:a.roundId}),s.push({productId:n.id,productName:n.groupName,productImage:n.imageUrls?.[0]||"/placeholder.svg",category:n.category||"미지정",storageType:n.storageType,round:a,uniqueId:`${n.id}-${a.roundId}`,enrichedVariantGroups:[],dynamicStatus:{text:"데이터 오류",className:"error"}});return}const c=a.variantGroups.map(C=>{const y=`${n.id}-${a.roundId}-${C.id}`,T=o.reservedQuantitiesMap.get(y)||0,G=C.totalPhysicalStock??-1,_=G===-1?1/0:G-T,W=ue(a,_);return{...C,reservedQuantity:T,pickedUpQuantity:o.pickedUpQuantitiesMap.get(y)||0,configuredStock:G,remainingStock:_,dynamicStatus:W}}),p=c.every(C=>C.dynamicStatus.className==="sold-out"),h=c.reduce((C,y)=>C+(y.remainingStock===1/0?1/0:y.remainingStock),0),N=p?{text:"매진",className:"sold-out"}:ue(a,h);s.push({productId:n.id,productName:n.groupName,productImage:n.imageUrls?.[0]||"/placeholder.svg",category:n.category||"미지정",storageType:n.storageType,round:a,uniqueId:`${n.id}-${a.roundId}`,enrichedVariantGroups:c,dynamicStatus:N})})}),M&&(s=s.filter(n=>n.productName.toLowerCase().includes(M.toLowerCase())||n.round.roundName.toLowerCase().includes(M.toLowerCase()))),S!=="all"&&(s=s.filter(n=>n.category===S)),j!=="all"&&(s=s.filter(n=>n.dynamicStatus.className===j||n.enrichedVariantGroups.some(a=>a.dynamicStatus.className===j))),s.sort((n,a)=>{const c=u.key;let p,h;if(c==="roundCreatedAt")p=I(n.round.createdAt)?.getTime()||0,h=I(a.round.createdAt)?.getTime()||0;else if(c==="pickupDate")p=I(n.round.pickupDate)?.getTime()||0,h=I(a.round.pickupDate)?.getTime()||0;else if(c==="expirationDate"){const N=n.enrichedVariantGroups.length>0?Math.min(...n.enrichedVariantGroups.map(y=>K(y))):1/0,C=a.enrichedVariantGroups.length>0?Math.min(...a.enrichedVariantGroups.map(y=>K(y))):1/0;if(p=N,h=C,p===1/0&&h!==1/0)return 1;if(h===1/0&&p!==1/0)return-1;if(p===1/0&&h===1/0)return 0}else p=n[c]??0,h=a[c]??0;return u.direction==="asc"?p<h?-1:1:p>h?-1:1})},[o,M,S,j,u]);l.useEffect(()=>{b(1)},[M,S,j,v]);const F=l.useMemo(()=>{const s=(d-1)*v;return L.slice(s,s+v)},[L,d,v]);l.useEffect(()=>{const s=new Set(L.filter(n=>n.enrichedVariantGroups.length>1).map(n=>n.uniqueId));ee(s)},[L]);const U=s=>{E(n=>({key:s,direction:n.key===s&&n.direction==="asc"?"desc":"asc"}))},be=(s,n)=>{z(s),$(a=>({...a,[s]:n===-1?"":String(n)}))},ve=async(s,n)=>{z(null);const a=g[s];if(a===void 0)return;const[c,p,h]=s.split("_"),N=parseInt(a,10);if(isNaN(N)||N<0&&N!==-1){k.error("재고는 0 이상의 숫자 또는 -1(무제한)만 입력 가능합니다.");return}const C=n.enrichedVariantGroups.find(G=>G.id===h);if(!C){k.error("재고를 업데이트할 상품 정보를 찾지 못했습니다.");return}const y=C.configuredStock,T=N-y;if(y!==-1&&N!==-1&&T>0){const _=ke({productId:c,roundId:p,variantGroupId:h,additionalStock:T});await k.promise(_,{loading:"재고 추가 및 대기자 전환 처리 중...",success:W=>(R(),W.data.convertedCount>0?`재고가 추가되고 ${W.data.convertedCount}명의 대기자가 예약으로 전환되었습니다.`:"재고가 성공적으로 업데이트되었습니다."),error:W=>W.message||"재고 처리 중 오류가 발생했습니다."})}else{const G=Fe([{productId:c,roundId:p,variantGroupId:h,newStock:N}]);await k.promise(G,{loading:"재고 정보 업데이트 중...",success:"재고가 성공적으로 업데이트되었습니다!",error:"업데이트 중 오류가 발생했습니다."}),await R()}},Se=s=>{ee(n=>{const a=new Set(n);return a.has(s)?a.delete(s):a.add(s),a})},Ie=(s,n)=>{O(a=>{const c=new Set(a);return n?c.add(s):c.delete(s),c})},Ce=s=>{s.target.checked?O(new Set(F.map(n=>n.uniqueId))):O(new Set)},we=async()=>{if(A.size===0){k.error("선택된 항목이 없습니다.");return}const s=Array.from(A).map(a=>{const c=a.indexOf("-");if(c===-1)return H("ProductListPageAdmin.bulkEnd.invalidId",new Error("invalid uniqueId"),{id:a}),null;const p=a.substring(0,c),h=a.substring(c+1);return{productId:p,roundId:h,newStatus:"ended"}}).filter(a=>a!==null);if(s.length===0){k.error("유효한 항목이 없습니다.");return}const n=qe(s);await k.promise(n,{loading:`${s.length}개 항목의 판매를 종료하는 중...`,success:"선택된 항목이 모두 판매 종료 처리되었습니다.",error:"일괄 작업 중 오류가 발생했습니다."}),O(new Set),R()},De=async()=>{if(A.size===0){k.error("삭제할 항목이 없습니다.");return}k(s=>e.jsxs("div",{className:"confirmation-toast-content",style:{maxWidth:"420px",textAlign:"center"},children:[e.jsx(He,{size:44,style:{color:"var(--danger-color)",margin:"0 auto 1rem"}}),e.jsx("h4",{style:{fontSize:"1.2rem",fontWeight:"bold"},children:"선택 항목 영구 삭제"}),e.jsxs("p",{style:{margin:"0.5rem 0 1rem"},children:["정말로 선택한 ",e.jsxs("strong",{children:[A.size,"개"]}),"의 판매 회차를 영구적으로 삭제하시겠습니까?",e.jsx("br",{}),e.jsx("strong",{style:{color:"var(--danger-color)"},children:"이 작업은 되돌릴 수 없습니다."})]}),e.jsxs("div",{className:"toast-buttons",style:{display:"flex",gap:"10px"},children:[e.jsx("button",{className:"common-button button-secondary button-medium",style:{flex:1},onClick:()=>k.dismiss(s.id),children:"취소"}),e.jsx("button",{className:"common-button button-danger button-medium",style:{flex:1},onClick:async()=>{k.dismiss(s.id);const n=Array.from(A).map(c=>{const p=c.indexOf("-");if(p===-1)return H("ProductListPageAdmin.bulkDelete.invalidId",new Error("invalid uniqueId"),{id:c}),null;const h=c.substring(0,p),N=c.substring(p+1);return{productId:h,roundId:N}}).filter(c=>c!==null);if(n.length===0){k.error("삭제할 유효한 항목이 없습니다.");return}const a=Re(n);await k.promise(a,{loading:`${n.length}개 항목을 삭제하는 중...`,success:"선택된 항목이 모두 삭제되었습니다.",error:"일괄 삭제 중 오류가 발생했습니다."}),O(new Set),R()},children:"삭제 확인"})]})]}),{id:"bulk-delete-confirm",duration:1/0,position:"top-center"})},$e=(s,n,a,c,p)=>{se({productId:s,roundId:n,variantGroupId:a,productName:c,roundName:p}),te(!0)},Ae=()=>{te(!1),se(null)},Pe=()=>{R()},Me=F.length>0&&A.size>=F.length&&F.every(s=>A.has(s.uniqueId));return t?e.jsx(Ge,{}):e.jsxs("div",{className:"admin-page-container product-list-admin-container",children:[e.jsxs("header",{className:"admin-page-header",children:[e.jsxs("h1",{className:"admin-page-title",children:[e.jsx(le,{size:28})," 통합 판매 관리"]}),e.jsxs("button",{onClick:()=>ye("/admin/products/add"),className:"admin-add-button",title:"완전히 새로운 대표 상품을 시스템에 등록합니다.",children:[e.jsx(Y,{size:18})," 신규 대표 상품 추가"]})]}),e.jsxs("div",{className:"admin-tabs",children:[e.jsxs("button",{className:`admin-tab-button ${D==="rounds"?"active":""}`,onClick:()=>q("rounds"),children:[e.jsx(le,{size:16})," 회차별 관리"]}),e.jsxs("button",{className:`admin-tab-button ${D==="analysis"?"active":""}`,onClick:()=>q("analysis"),children:[e.jsx(_e,{size:16})," 수익 분석"]})]}),e.jsx("div",{className:"admin-tab-content",children:D==="rounds"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"product-list-controls-v2",children:[e.jsxs("div",{className:"search-bar-wrapper",children:[e.jsx(Ke,{size:18,className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"상품명 또는 회차명으로 검색...",value:M,onChange:s=>f(s.target.value),className:"search-input"})]}),e.jsx("div",{className:"filter-sort-wrapper",children:e.jsxs("div",{className:"control-group",children:[e.jsx(Je,{size:16}),e.jsxs("select",{value:S,onChange:s=>r(s.target.value),className:"control-select",children:[e.jsx("option",{value:"all",children:"모든 카테고리"}),o.categories.map(s=>e.jsx("option",{value:s.name,children:s.name},s.id))]}),e.jsxs("select",{value:j,onChange:s=>m(s.target.value),className:"control-select",children:[e.jsx("option",{value:"all",children:"모든 상태"}),e.jsx("option",{value:"selling",children:"공구예약중"}),e.jsx("option",{value:"late-reservation",children:"추가예약중"}),e.jsx("option",{value:"pickup",children:"픽업중/현장판매"}),e.jsx("option",{value:"sold-out",children:"매진"}),e.jsx("option",{value:"ended",children:"판매종료"}),e.jsx("option",{value:"scheduled",children:"판매예정"})]})]})}),e.jsxs("div",{className:"bulk-action-wrapper",children:[e.jsxs("button",{className:"bulk-action-button",onClick:we,disabled:A.size===0,children:[e.jsx(de,{size:16})," 선택 항목 판매 종료"]}),e.jsxs("button",{className:"bulk-action-button danger",onClick:De,disabled:A.size===0,children:[e.jsx(de,{size:16})," 선택 항목 영구 삭제"]})]})]}),e.jsx("div",{className:"admin-product-table-container",children:e.jsxs("table",{className:"admin-product-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("input",{type:"checkbox",checked:Me,onChange:Ce,title:"전체 선택/해제"})}),e.jsx("th",{children:"No."}),e.jsxs("th",{className:"sortable-header",onClick:()=>U("roundCreatedAt"),children:["등록일 ",u.key==="roundCreatedAt"&&(u.direction==="asc"?"▲":"▼")]}),e.jsxs("th",{className:"sortable-header",onClick:()=>U("pickupDate"),children:["픽업일 ",u.key==="pickupDate"&&(u.direction==="asc"?"▲":"▼")]}),e.jsxs("th",{className:"sortable-header",onClick:()=>U("category"),children:["카테고리 ",u.key==="category"&&(u.direction==="asc"?"▲":"▼")]}),e.jsx("th",{children:"보관"}),e.jsxs("th",{className:"sortable-header",onClick:()=>U("productName"),children:["상품명 / 회차명 ",u.key==="productName"&&(u.direction==="asc"?"▲":"▼")]}),e.jsx("th",{children:"상태"}),e.jsx("th",{children:"가격"}),e.jsxs("th",{className:"sortable-header",onClick:()=>U("expirationDate"),children:["유통기한 ",u.key==="expirationDate"&&(u.direction==="asc"?"▲":"▼")]}),e.jsx("th",{title:"예약된 수량 / 전체 대기자 수",children:"예약/대기"}),e.jsx("th",{title:"픽업 완료된 수량",children:"픽업"}),e.jsx("th",{children:"재고"}),e.jsx("th",{children:"관리"})]})}),e.jsx("tbody",{children:F.length>0?F.map((s,n)=>e.jsx(at,{item:s,index:(d-1)*v+n,isExpanded:J.has(s.uniqueId),isSelected:A.has(s.uniqueId),editingStockId:P,stockInputs:g,onToggleExpansion:Se,onSelectionChange:Ie,onStockEditStart:be,onStockEditSave:ve,onSetStockInputs:$,onOpenWaitlistModal:$e},s.uniqueId)):e.jsx("tr",{children:e.jsx("td",{colSpan:14,style:{textAlign:"center",padding:"4rem",color:"var(--text-color-light)"},children:"표시할 판매 회차가 없습니다."})})})]})}),e.jsx(nt,{currentPage:d,totalPages:Math.ceil(L.length/v),onPageChange:b,itemsPerPage:v,onItemsPerPageChange:s=>w(Number(s.target.value)),totalItems:L.length})]}):e.jsxs("div",{className:"placeholder-container",children:[e.jsx("h3",{children:"수익 분석 (준비중)"}),e.jsx("p",{children:"이곳에서 상품별 원가, 판매가, 예약 수량을 기반으로 한 수익 및 수익률 분석 데이터를 볼 수 있습니다."}),e.jsx("p",{children:"상품 데이터에 '원가(cost)' 필드를 추가하는 작업이 선행되어야 합니다."})]})}),e.jsx(rt,{isOpen:fe,onClose:Ae,data:Ne,onSuccess:Pe})]})};export{It as default};
