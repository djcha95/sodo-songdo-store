import{b as oe,d as X,u as ce,h as le,g as de,r,i as ue,k as me,l as W,x as pe,y as he,V as x,j as e,L as fe,T as xe}from"./index-BMz7zIRN.js";import{d as K}from"./dayjs.min-B5lyAaGD.js";import{u as ge}from"./useLongPress-C3c2NboI.js";import{s as q,a as je}from"./toastUtils-C4esVHua.js";import{O as ye}from"./OptimizedImage-DzTUm3mu.js";import{R as ve}from"./refresh-cw-rA7dvjEr.js";import{C as V}from"./circle-x-fkkSg6hU.js";import{H as be}from"./hourglass-Cbw8WS9u.js";import{S as Ie}from"./shopping-cart-DDLkxA9X.js";import{T as L}from"./triangle-alert-DUarG1oM.js";import{C as J,B as Ne}from"./calendar-days-C3Lc1TML.js";import{S as Y}from"./shield-x-DqlWjWof.js";import{I as Z}from"./info-DxE8bBlt.js";import{M as ke}from"./minus-CdiIzwb3.js";import{P as Se}from"./plus-Q3suSHkb.js";import{f as we,k as Ce}from"./ko-rCIX9F0R.js";import"./imageUtils-BPiZeTFW.js";import"./createLucideIcon-Df3tO_ja.js";const Pe=t=>{if(!t)return null;if(t instanceof Date)return t;if(typeof t.toDate=="function")return t.toDate();if(typeof t=="object"&&(t.seconds!==void 0||t._seconds!==void 0)){const l=t.seconds??t._seconds,f=t.nanoseconds??t._nanoseconds??0;return new xe(l,f).toDate()}if(typeof t=="string"){const l=new Date(t);if(!isNaN(l.getTime()))return l}return null},_=({item:t,isSelected:l,isEligible:f,onSelect:p,onImageClick:h})=>{const{updateCartItemQuantity:g}=X(),[b,I]=r.useState(!1),[S,z]=r.useState(t.quantity.toString()),w=r.useRef(null),j=r.useMemo(()=>t.stock===null||t.stock===-1?999:t.stock,[t.stock]);r.useEffect(()=>{b||z(t.quantity.toString())},[t.quantity,b]),r.useEffect(()=>{b&&w.current&&w.current.focus()},[b]);const D=i=>{i.stopPropagation(),f&&I(!0)},C=r.useCallback(()=>{const i=parseInt(S,10),y=!isNaN(i)&&i>0?Math.min(i,j):1;y!==t.quantity&&(g(t.id,y),i>j?q("error",`최대 ${j}개까지만 구매 가능합니다.`):i<1&&q("error","최소 1개 이상 구매해야 합니다.")),I(!1)},[S,t.id,t.quantity,j,g]),P=i=>{i.key==="Enter"&&C()},N=r.useCallback(i=>{const y=()=>{if(!f)return;const v=t.quantity+i;v<1||v>j||g(t.id,v)};return ge(y,y,{delay:100})},[t,j,g,f]),R=N(-1),k=N(1),T=i=>{const y=Pe(i);return y?we(y,"M/d(EEE)",{locale:Ce})+" 픽업":"픽업일 정보 없음"};return e.jsxs("div",{className:`cart-item-card ${l?"selected":""} ${f?"":"ineligible"}`,onClick:()=>p(t.id),children:[!f&&e.jsxs("div",{className:"ineligible-overlay",children:[e.jsx(Y,{size:24}),e.jsxs("span",{children:["현재 등급으로",e.jsx("br",{}),"예약 불가"]})]}),e.jsx("div",{className:"item-image-wrapper",onClick:i=>h(i,t.productId),children:e.jsx(ye,{originalUrl:t.imageUrl,size:"200x200",alt:t.productName,className:"item-image"})}),e.jsxs("div",{className:"item-details-wrapper",children:[e.jsxs("div",{className:"item-header",children:[e.jsxs("div",{className:"item-name-group",children:[e.jsx("span",{className:"item-product-name",children:t.variantGroupName}),e.jsxs("span",{className:"item-option-name",children:["선택: ",t.itemName]})]}),e.jsxs("div",{className:"item-pickup-info",children:[e.jsx(J,{size:14}),e.jsx("span",{children:T(t.pickupDate)})]})]}),e.jsxs("div",{className:"item-footer",children:[t.status==="WAITLIST"?e.jsxs("div",{className:"waitlist-status-badge",children:[e.jsx(Z,{size:14}),e.jsx("span",{children:"재고 확보 시 자동 예약 전환"})]}):e.jsxs("div",{className:"item-total-price",children:[(t.unitPrice*t.quantity).toLocaleString(),"원"]}),e.jsxs("div",{className:"item-quantity-controls",onClick:i=>i.stopPropagation(),children:[e.jsx("button",{...R,disabled:t.quantity<=1||!f,children:e.jsx(ke,{size:18})}),b?e.jsx("input",{ref:w,type:"number",className:"quantity-input",value:S,onChange:i=>z(i.target.value),onBlur:C,onKeyDown:P}):e.jsx("span",{className:"quantity-display",onClick:D,children:t.quantity}),e.jsx("button",{...k,disabled:t.quantity>=j||!f,children:e.jsx(Se,{size:18})})]})]})]})]})},Ve=()=>{const{user:t,userDocument:l,isSuspendedUser:f}=oe(),{reservationItems:p,waitlistItems:h,removeItems:g,updateCartItemQuantity:b}=X(),I=ce(),{runPageTourIfFirstTime:S}=le(),{isPreLaunch:z,launchDate:w}=de(),[j,D]=r.useState(!1),[C,P]=r.useState(!0),[N,R]=r.useState(new Set),[k,T]=r.useState(new Set),[i,y]=r.useState(new Set),v=r.useMemo(()=>ue(me(),"asia-northeast3"),[]),U=r.useMemo(()=>W(v,"checkCartStock"),[v]),ee=r.useMemo(()=>W(v,"submitOrder"),[v]),se=r.useMemo(()=>W(v,"addWaitlistEntry"),[v]);r.useEffect(()=>{l?.hasCompletedTutorial&&S("hasSeenCartPage",pe)},[l,S]);const{eligibleReservationItems:u,eligibleReservationTotal:M}=r.useMemo(()=>{const a=p.filter(d=>!i.has(d.id)),n=a.reduce((d,o)=>d+o.unitPrice*o.quantity,0);return{eligibleReservationItems:a,eligibleReservationTotal:n}},[p,i]),E=r.useCallback(async a=>{if(!l||a.length===0)return P(!1),!0;P(!0);try{const n=[...new Set(a.map(s=>s.productId))],d=await he(n),o=new Map(d.map(s=>[s.id,s])),c=new Set;a.forEach(s=>{const F=o.get(s.productId)?.salesHistory.find(ie=>ie.roundId===s.roundId)?.allowedTiers||[];F.length>0&&!F.includes(l.loyaltyTier)&&c.add(s.id)}),y(c);const{data:m}=await U({items:a});return(m.updatedItems.length>0||m.removedItemIds.length>0)&&(r.startTransition(()=>{m.updatedItems.forEach(s=>b(s.id,s.newQuantity)),m.removedItemIds.length>0&&g(m.removedItemIds)}),x.error("일부 상품의 재고가 변경되어 자동 조정되었습니다.")),m.isSufficient||x.error("일부 상품의 재고가 부족하여 주문을 진행할 수 없습니다."),m.isSufficient}catch(n){return console.error("Cloud Function 호출 중 오류:",n),x.error(n.message||"장바구니 정보를 동기화하는 중 오류가 발생했습니다."),!1}finally{P(!1)}},[U,g,b,l]),te=r.useMemo(()=>p.map(a=>a.id).join(","),[p]);r.useEffect(()=>{E(p)},[te,E]);const Q=r.useCallback((a,n)=>{(n==="reservation"?R:T)(o=>{const c=new Set(o);return c.has(a)?c.delete(a):c.add(a),c})},[]),A=r.useCallback(a=>{const n=a==="reservation"?N:k;if(n.size===0){q("info","삭제할 상품을 선택해주세요.");return}x(d=>e.jsxs("div",{className:"confirmation-toast-content",children:[e.jsx(L,{size:44,className:"toast-icon",style:{color:"var(--danger-color)"}}),e.jsx("h4",{children:"선택 상품 삭제"}),e.jsxs("p",{children:[n.size,"개의 상품을 장바구니에서 삭제하시겠습니까?"]}),e.jsxs("div",{className:"toast-buttons",children:[e.jsx("button",{className:"common-button button-secondary button-medium",onClick:()=>x.dismiss(d.id),children:"취소"}),e.jsx("button",{className:"common-button button-danger button-medium",onClick:()=>{x.dismiss(d.id),g(Array.from(n)),a==="reservation"?R(new Set):T(new Set),q("success","선택된 상품이 삭제되었습니다.")},children:"삭제"})]})]}),{id:"bulk-delete-confirmation",duration:1/0,style:{background:"transparent",boxShadow:"none",border:"none",padding:0}})},[N,k,g]),B=r.useCallback((a,n)=>{a.stopPropagation(),I(`/product/${n}`)},[I]),G=r.useMemo(()=>u.some(a=>a.isPrepaymentRequired||a.stock!==null&&a.stock!==-1),[u]),ae=async()=>{if(!t||!t.uid||!l){q("error","요청을 확정하려면 로그인이 필요합니다."),I("/login",{state:{from:"/cart"},replace:!0});return}if(f){q("error","반복적인 약속 불이행으로 공동구매 참여가 제한되었습니다.");return}if(j||u.length===0&&h.length===0||!await E(u))return;D(!0);const n=u.length>0?(()=>{const o=u.map(s=>({id:s.id,productId:s.productId,productName:s.productName,imageUrl:s.imageUrl,roundId:s.roundId,roundName:s.roundName,variantGroupId:s.variantGroupId,variantGroupName:s.variantGroupName,itemId:s.itemId,itemName:s.itemName,quantity:s.quantity,unitPrice:s.unitPrice,stock:s.stock,stockDeductionAmount:s.stockDeductionAmount,arrivalDate:s.arrivalDate??null,pickupDate:s.pickupDate,deadlineDate:s.deadlineDate,isPrepaymentRequired:s.isPrepaymentRequired})),m=l?.loyaltyTier==="주의 요망"||G;return{userId:t.uid,items:o,totalPrice:M,customerInfo:{name:t.displayName||"미상",phone:l?.phone||""},pickupDate:u[0].pickupDate,wasPrepaymentRequired:m,notes:""}})():null,d=[];n&&d.push(ee(n)),h.forEach(o=>{const c={productId:o.productId,roundId:o.roundId,quantity:o.quantity,variantGroupId:o.variantGroupId,itemId:o.itemId};d.push(se(c))}),je(Promise.all(d),{loading:"요청을 처리하는 중입니다...",success:o=>{if(n&&o.length>0){const s=o[0];if(s&&s.data&&s.data.success===!1)throw new Error(s.data.message||"서버에서 주문 처리에 실패했습니다.")}const c=[...u.map(s=>s.id),...h.map(s=>s.id)];if(n?.wasPrepaymentRequired??!1){const s="prepayment-toast",H=()=>{x.dismiss(s),r.startTransition(()=>{g(c),I("/mypage/history")})};return x.custom($=>e.jsx("div",{className:"prepayment-modal-overlay",children:e.jsxs("div",{className:`prepayment-modal-content ${$.visible?"animate-enter":"animate-leave"}`,children:[e.jsx("div",{className:"toast-icon-wrapper",children:e.jsx(Ne,{size:48})}),e.jsx("h4",{children:"⚠️ 선입금 후 예약이 확정됩니다"}),e.jsxs("p",{children:["'주의 요망' 등급이거나 ",e.jsx("strong",{style:{color:"var(--danger-color)"},children:"한정 수량 상품"}),"이 포함되어 있습니다. ",e.jsx("br",{}),"마감 시간 전까지 입금 후 채널톡으로 내역을 보내주세요."]}),e.jsxs("div",{className:"bank-info",children:[e.jsx("strong",{children:"카카오뱅크 3333-12-3456789 (소도몰)"}),e.jsxs("div",{className:"price-to-pay",children:["입금할 금액: ",e.jsxs("strong",{children:[M.toLocaleString(),"원"]})]})]}),e.jsxs("small",{children:["관리자가 확인 후 예약을 확정 처리해 드립니다.",e.jsx("br",{}),"미입금 시 예약은 자동 취소될 수 있습니다."]}),e.jsx("button",{className:"modal-confirm-button",onClick:H,children:"확인 및 주문내역으로 이동"})]})}),{id:s,duration:1/0}),""}else return setTimeout(()=>{r.startTransition(()=>{g(c),I("/mypage/history")})},50),u.length>0&&h.length>0?"예약 및 대기 신청이 모두 완료되었습니다!":u.length>0?"예약이 성공적으로 완료되었습니다!":"대기 신청이 성공적으로 완료되었습니다!"},error:o=>o.message||"요청 처리 중 오류가 발생했습니다."}).finally(()=>{D(!1)})},ne=()=>{if(z){x(`🛍️ 상품 예약은 ${K(w).format("M/D")} 정식 런칭 후 가능해요!`,{icon:"🗓️",position:"top-center"});return}const a=l?.loyaltyTier==="주의 요망",n=u.some(s=>s.stock!==null&&s.stock!==-1),d=a||G,o=d?"선입금 안내":"요청 확정";let c="";u.length>0&&h.length>0?c="예약 상품과 대기 상품에 대한 요청을 함께 확정하시겠습니까?":u.length>0?c="예약 상품에 대한 주문을 확정하시겠습니까?":c="대기 상품에 대한 신청을 확정하시겠습니까?";let m="예약 확정 후 1차 마감일 이후 취소 시 패널티가 부과될 수 있습니다.";n?m="한정 수량 상품은 선입금 및 1:1 채팅 확인 후에만 최종 확정됩니다. 단순 예약은 재고를 확보하지 않습니다.":d&&(m="선택하신 상품은 예약 후 선입금이 필요합니다."),x(s=>e.jsxs("div",{className:"confirmation-toast-content",children:[e.jsx(Z,{size:44,className:"toast-icon"}),e.jsx("h4",{children:o}),e.jsx("p",{style:{whiteSpace:"pre-line"},children:c}),e.jsxs("div",{className:"toast-warning-box",children:[e.jsx(L,{size:16})," ",m]}),e.jsxs("div",{className:"toast-buttons",children:[e.jsx("button",{className:"common-button button-secondary button-medium",onClick:()=>x.dismiss(s.id),children:"취소"}),e.jsx("button",{className:"common-button button-accent button-medium",onClick:()=>{x.dismiss(s.id),ae()},children:"확인"})]})]}),{id:"order-confirmation",duration:1/0,style:{background:"transparent",boxShadow:"none",border:"none",padding:0}})},O=(()=>{if(z)return{text:e.jsxs(e.Fragment,{children:[e.jsx(J,{size:20})," ",K(w).format("M/D")," 정식 오픈!"]}),disabled:!0};if(f)return{text:e.jsxs(e.Fragment,{children:[e.jsx(Y,{size:20})," 참여 제한"]}),disabled:!0};if(j||C)return{text:"처리 중...",disabled:!0};const a=u.length>0,n=h.length>0;return a&&n?{text:"예약 및 대기 확정하기",disabled:!1}:a?{text:"예약 확정하기",disabled:!1}:n?{text:"대기 신청 확정하기",disabled:!1}:{text:"예약/대기 상품 없음",disabled:!0}})(),re=r.useMemo(()=>[...p,...h],[p,h]);return e.jsx("div",{className:"cart-page-wrapper",children:e.jsx("div",{className:"customer-page-container cart-container",children:e.jsxs("div",{className:"cart-page-layout",children:[e.jsxs("div",{className:"cart-items-column",children:[e.jsxs("div",{className:"cart-section-header",children:[e.jsxs("h2",{className:"cart-section-title",children:["🛒 예약 상품 (",p.length,") ",C&&e.jsx(ve,{size:18,className:"spin-icon"})]}),N.size>0&&e.jsxs("button",{className:"bulk-remove-btn",onClick:()=>A("reservation"),children:[e.jsx(V,{size:16})," 선택 삭제 (",N.size,")"]})]}),e.jsx("div",{"data-tutorial-id":"cart-reservation-list",children:p.length>0?e.jsx("div",{className:"cart-items-list",children:p.map(a=>e.jsx(_,{item:a,isSelected:N.has(a.id),isEligible:!i.has(a.id),onSelect:n=>Q(n,"reservation"),onImageClick:B},a.id))}):e.jsx("div",{className:"info-box",children:e.jsx("p",{children:"장바구니에 담긴 예약 상품이 없습니다."})})}),e.jsxs("div",{className:"waitlist-section",children:[e.jsxs("div",{className:"cart-section-header waitlist-header",children:[e.jsxs("h2",{className:"cart-section-title",children:[e.jsx(be,{size:18})," 대기 상품 (",h.length,")"]}),k.size>0&&e.jsxs("button",{className:"bulk-remove-btn",onClick:()=>A("waitlist"),children:[e.jsx(V,{size:16})," 선택 삭제 (",k.size,")"]})]}),e.jsx("div",{"data-tutorial-id":"cart-waitlist-list",children:h.length>0?e.jsx("div",{className:"cart-items-list",children:h.map(a=>e.jsx(_,{item:a,isSelected:k.has(a.id),isEligible:!0,onSelect:n=>Q(n,"waitlist"),onImageClick:B},a.id))}):e.jsx("div",{className:"info-box",children:e.jsx("p",{children:"품절 상품에 '대기 신청'을 하면 여기에 표시됩니다."})})})]}),re.length===0&&!C&&e.jsxs("div",{className:"empty-cart-message",children:[e.jsx(Ie,{size:64,className:"empty-cart-icon"}),e.jsx("p",{children:"장바구니와 대기 목록이 비어있습니다."}),e.jsx(fe,{to:"/",className:"continue-shopping-btn",children:"쇼핑 계속하기"})]})]}),e.jsx("div",{className:"cart-summary-column",children:e.jsxs("div",{className:"cart-summary-card","data-tutorial-id":"cart-checkout-button",children:[e.jsx("button",{className:"checkout-btn",onClick:ne,disabled:O.disabled,children:O.text}),e.jsx("div",{className:"cart-summary-details",children:M!==p.reduce((a,n)=>a+n.unitPrice*n.quantity,0)&&e.jsxs("div",{className:"summary-row warning-text",children:[e.jsx("span",{children:"(등급 제한 제외)"}),e.jsx("span",{})]})}),i.size>0&&e.jsxs("div",{className:"ineligible-notice-box",children:[e.jsx(L,{size:16}),e.jsxs("span",{children:["현재 등급으로 참여할 수 없는 상품(",i.size,"개)은",e.jsx("br",{}),"자동으로 제외되었습니다."]})]})]})})]})})})};export{Ve as default};
