rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.role in ['admin', 'master'];
    }

    // --- 공개 정보 (누구나 읽기) ---
    match /products/{productId}   { allow read: if true; allow write: if isAdmin(); }
    match /banners/{bannerId}     { allow read: if true; allow write: if isAdmin(); }
    match /categories/{categoryId}{ allow read: if true; allow write: if isAdmin(); }
    match /storeInfo/{docId}      { allow read: if true; allow write: if isAdmin(); }

    // --- 사용자 정보 ---
    match /users/{userId} {
      // 본인 or 관리자일 때만 get 허용
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // 사용자 목록(list)은 관리자만
      allow list: if isAdmin();

      // 본인 문서 생성 허용(최초 가입/프로필 생성 등)
      allow create: if request.auth != null && request.auth.uid == userId;

      // 본인 문서 업데이트 허용(민감정보 필드 통제는 필요시 필드 검사로 강화)
      allow update: if request.auth != null && request.auth.uid == userId;

      // 삭제는 관리자만
      allow delete: if isAdmin();

      // 하위 컬렉션(알림, 장바구니 등) — 본인 또는 관리자
      match /{subcollection}/{docId} {
        allow read, write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // --- 주문 정보 ---
    match /orders/{orderId} {
      // ✅ 문서 단위 read: 본인 주문 or 관리자만
      allow read: if request.auth != null
                  && (resource.data.userId == request.auth.uid || isAdmin());

      // ✅ 생성: 문서에 기록될 userId가 본인일 때만 허용
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      // 수정/삭제: 관리자만(일반 사용자는 불가)
      allow update, delete: if isAdmin();
    }
  }
}
