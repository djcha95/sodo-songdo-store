rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.role in ['admin', 'master'];
    }

    // --- 공개 정보 (누구나 읽기) ---
    match /products/{productId}   { allow read: if true; allow write: if isAdmin(); }
    match /banners/{bannerId}     { allow read: if true; allow write: if isAdmin(); }
    match /categories/{categoryId}{ allow read: if true; allow write: if isAdmin(); }
    match /storeInfo/{docId}      { allow read: if true; allow write: if isAdmin(); }

    // --- 사용자 정보 ---
    match /users/{userId} {
      // 본인 or 관리자일 때만 get 허용
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // 사용자 목록(list)은 관리자만
      allow list: if isAdmin();

      // 본인 문서 생성 허용(최초 가입/프로필 생성 등)
      allow create: if request.auth != null && request.auth.uid == userId;

      // 본인 문서 업데이트 허용(민감정보 필드 통제는 필요시 필드 검사로 강화)
      allow update: if request.auth != null && request.auth.uid == userId;

      // 삭제는 관리자만
      allow delete: if isAdmin();

      // 하위 컬렉션(알림, 장바구니 등) — 본인 또는 관리자
      match /{subcollection}/{docId} {
        allow read, write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // --- 주문 정보 ---
    match /orders/{orderId} {
      // ✅ 문서 단위 read: 본인 주문 or 관리자만
      allow read: if request.auth != null
                  && (resource.data.userId == request.auth.uid || isAdmin());

      // ✅ [정책] orders 컬렉션은 클라이언트 write 전면 금지
      // - 주문 생성/수정/취소/상태변경은 모두 Cloud Functions(Admin SDK)에서만 수행
      allow create, update, delete: if false;
    }

    // --- 재고 칠판(stockStats_v1) ---
    match /stockStats_v1/{docId} {
      // ✅ 운영/디버깅용: 관리자만 읽기 허용 (고객 앱은 CF가 오버레이하여 전달)
      allow read: if isAdmin();
      // ✅ [정책] stockStats_v1은 서버에서만 갱신
      allow create, update, delete: if false;
    }

    // --- 리뷰 정보 ---
    // ✅ 고객(후기 이벤트 페이지 등)에서 읽기는 공개
    // ✅ 등록/수정/삭제는 관리자(토큰 role: admin/master)만 허용
    match /reviews/{reviewId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
