<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소도몰 디지털 배너</title>
    <style>
        /* ✅ [추가] 화면 번인 방지를 위한 미세한 움직임 애니메이션 */
        @keyframes subtle-move {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(2px, -2px); }
            50% { transform: translate(-2px, 2px); }
            75% { transform: translate(-2px, -2px); }
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        #slideshow-container { width: 100%; height: 100%; position: relative; }
        .slide { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; transition: opacity 1.5s ease-in-out;
            /* ✅ [추가] 번인 방지 애니메이션 적용 */
            animation: subtle-move 20s infinite ease-in-out;
        }
        .slide.active { opacity: 1; }
        .slide .background-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scale(1.1);
            transition: transform 15s ease-out;
        }
        .slide.active .background-image { transform: scale(1.0); }
        .overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 40px 50px; box-sizing: border-box; background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0) 100%); display: flex; justify-content: space-between; align-items: flex-end; }
        .product-info { max-width: 65%; }
        .product-status { display: inline-block; padding: 10px 20px; font-size: 24px; font-weight: bold; border-radius: 15px; margin-bottom: 15px; color: #fff; }
        .product-status.primary { background-color: rgba(255, 82, 82, 0.8); box-shadow: 0 0 15px rgba(255, 82, 82, 0.5); }
        .product-status.secondary { background-color: rgba(255, 167, 38, 0.8); box-shadow: 0 0 15px rgba(255, 167, 38, 0.5); }
        .product-name { font-size: 56px; font-weight: 800; line-height: 1.2; margin: 0 0 10px 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
        .product-price { font-size: 44px; font-weight: 500; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); margin-bottom: 5px; }
        .product-pickup {
            font-size: 38px;
            font-weight: 500;
            color: #ffdd80;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            margin-top: 10px;
        }
        .qr-code { padding: 15px; background-color: #fff; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .qr-code canvas, .qr-code img { display: block; width: 350px; height: 350px; }
        .qr-code p { font-size: 16px; font-weight: bold; color: #000; text-align: center; margin: 10px 0 0 0; }
        #loading-message { font-size: 40px; text-align: center; padding-top: 40vh; }
    </style>
</head>
<body>

    <div id="slideshow-container">
        <div id="loading-message">
            <p>오늘의 상품 정보를<br>불러오는 중입니다...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/isToday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/isTomorrow.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_isToday);
        dayjs.extend(dayjs_plugin_isTomorrow);
    </script>

    <script>
        const FIREBASE_PROJECT_ID = "sso-do"; 
        const FIREBASE_REGION = "asia-northeast3";
        const API_URL = `https://${FIREBASE_REGION}-${FIREBASE_PROJECT_ID}.cloudfunctions.net/getBannerProductsHttp`;

        const container = document.getElementById('slideshow-container');
        const loadingMessage = document.getElementById('loading-message');
        let currentIndex = 0;
        let productsToShow = [];
        const slideInterval = 12000;
        let slideshowTimer = null;

        function formatDateWithDay(dateInput) {
            if (!dateInput) return '미정';
            const date = dayjs(dateInput); 
            if (!date.isValid()) return '날짜 오류';
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            return `${date.format('M.D')}(${days[date.day()]})`;
        }

        function formatDeadline(dateInput) {
            if (!dateInput) return '';
            const deadline = dayjs(dateInput);
            if (!deadline.isValid()) return '';
            
            const time = deadline.format('HH:mm');
            if (deadline.isToday()) {
                return `(오늘 ${time} 마감)`;
            }
            if (deadline.isTomorrow()) {
                return `(내일 ${time} 마감)`;
            }
            return `(${deadline.format('M/D')} 마감)`;
        }

        async function fetchBannerProducts() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`서버 응답 오류: ${response.status}`);
                
                const result = await response.json();
                productsToShow = result.products || [];
                
                if (productsToShow.length > 0) {
                    loadingMessage.style.display = 'none';
                    initSlideshow();
                } else {
                    loadingMessage.innerHTML = '<p>현재 진행중인<br>공동구매 상품이 없습니다.</p>';
                }

            } catch (error) {
                console.error("상품 정보를 가져오는 데 실패했습니다:", error);
                loadingMessage.innerHTML = '<p>정보를 불러오는 데<br>실패했습니다. 잠시 후 새로고침 됩니다.</p>';
                setTimeout(() => location.reload(), 5000);
            }
        }

        function initSlideshow() {
            container.innerHTML = '';
            createSlides();
            if (productsToShow.length > 0) {
                document.getElementById('slide-0')?.classList.add('active');
                if (productsToShow.length > 1) {
                    if(slideshowTimer) clearInterval(slideshowTimer); 
                    slideshowTimer = setInterval(showNextSlide, slideInterval);
                }
            }
        }

        function createSlides() {
             productsToShow.forEach((product, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.id = `slide-${index}`;

                const statusMap = {
                    primary: { text: '🔥 공동구매 진행중', className: 'primary' },
                    secondary: { text: '⏰ 추가예약 진행중', className: 'secondary' }
                };
                const currentStatus = statusMap[product.status] || { text: '', className: '' };
                const productUrl = `https://www.sodo-songdo.store/product/${product.id}`;

                const deadlineText = product.status === 'primary' ? formatDeadline(product.deadlineDate) : '';
                const pickupDateFormatted = formatDateWithDay(product.pickupDate);

                slide.innerHTML = `
                    <img src="${product.imageUrl}" class="background-image" alt="${product.name}" />
                    <div class="overlay">
                        <div class="product-info">
                            <span class="product-status ${currentStatus.className}">${currentStatus.text} ${deadlineText}</span>
                            <h1 class="product-name">${product.name}</h1>
                            <p class="product-price">${product.price.toLocaleString()}원</p>
                            <p class="product-pickup">픽업일: ${pickupDateFormatted}</p>
                        </div>
                        <div class="qr-code">
                            <canvas id="qr-${index}"></canvas>
                            <p>스캔하여 바로 예약!</p>
                        </div>
                    </div>
                `;
                container.appendChild(slide);

                new QRious({
                    element: document.getElementById(`qr-${index}`),
                    value: productUrl,
                    size: 240,
                    level: 'H',
                });
            });
        }

        function showNextSlide() {
            const slides = document.querySelectorAll('.slide');
            if (slides.length === 0) return;
            slides[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + 1) % slides.length;
            slides[currentIndex].classList.add('active');
        }

        fetchBannerProducts();
        setInterval(fetchBannerProducts, 1000 * 60 * 10);

    </script>
</body>
</html>