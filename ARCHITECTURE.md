# 📂 프로젝트 구조 및 아키텍처

## 📁 디렉토리(폴더) 구조 설명

프로젝트의 주요 폴더와 파일 역할은 다음과 같습니다.

SODOMALL-APP/
├── public/              # 이미지, 폰트 등 정적 파일 보관
├── scripts/             # 프로젝트 관련 보조 스크립트 파일 보관 (DB 마이그레이션 등)
├── src/                 # ✅ 핵심 소스 코드가 있는 폴더
│   ├── assets/          # 로고, 아이콘 등 작은 이미지 파일 보관
│   ├── components/      # 여러 곳에서 재사용되는 UI 컴포넌트를 보관하며, 역할에 따라 admin/, customer/, common/ 등으로 하위 폴더를 구성
│   ├── context/         # 앱 전역 상태 관리를 위한 Context API 파일들 (인증, 장바구니 등)
│   ├── firebase/        # Firebase 초기 설정 및 기능별 서비스 함수 모음
│   ├── hooks/           # 커스텀 훅 (예: useHorizontalScroll) 보관
│   ├── layouts/         # 페이지들의 공통적인 뼈대(헤더, 푸터 등)을 정의
│   ├── pages/           # 웹사이트의 각 페이지 단위 컴포넌트
│   │   ├── admin/       # 관리자 관련 페이지
│   │   └── customer/    # 고객 관련 페이지
│   ├── styles/          # 전역적으로 사용되는 CSS 스타일 파일 보관
│   ├── types/           # 전역 TypeScript 타입 정의 파일 (react-html.d.ts 등)
│   └── utils/           # 공통 유틸리티 함수 보관 (예: 이미지 URL 변환, 등급 계산)
├── .env                 # API 키 등 민감한 정보 보관 (Git에 올리면 안 됨)
├── firebase.json        # Firebase 호스팅, Firestore 규칙 등 설정
├── functions/           # ✅ Firebase Cloud Functions (서버리스 백엔드) 소스 코드
│   ├── src/
│   │   ├── callable/    # 클라이언트 호출 가능 함수
│   │   ├── triggers/    # Firestore 데이터 변경 감지 함수
│   │   ├── scheduled/   # 스케줄링 함수
│   │   ├── utils/       # Functions에서 사용하는 공통 유틸리티 (helpers.js 등)
│   │   └── index.ts     # 모든 함수의 진입점
│   └── package.json
├── index.html           # 앱의 진입점이 되는 메인 HTML 파일
├── package.json         # 프로젝트 정보 및 의존성 라이브러리 목록
├── README.md            # 프로젝트 설명서 (메인 파일)
├── tsconfig.app.json    # Vite 앱을 위한 상세 TypeScript 설정 (경로 별칭 '@' 포함)
└── vite.config.ts       # Vite 빌드 도구 설정

## 📄 주요 파일 상세 설명

### `src/main.tsx`

-   React 애플리케이션의 **최초 진입점(Entry Point)**입니다.
-   `index.html` 파일의 'root' div를 찾아, 그 안에 메인 컴포넌트인 `<App />`을 렌더링(표시)하는 역할을 합니다.
-   `<StrictMode>`로 앱을 감싸서 개발 중 잠재적인 문제를 미리 감지하도록 돕습니다.

### `src/firebase/폴더`

Firebase와의 모든 통신을 담당하는 중앙 허브 역할을 하는 폴더입니다.
- **`firebaseConfig.ts`**: Firebase 초기 설정 코드가 포함되어 있습니다.
- 기능별 서비스 파일: Firestore 데이터베이스와의 통신을 기능별로 분리하여 관리합니다.
  - **`productService.ts`**: 상품 정보(생성, 수정, 조회, 대기자 등록) 관련 함수를 관리합니다. `getWaitlistForRound`, `addStockAndProcessWaitlist` 등 대기자 관리 핵심 로직과 **유사 상품명 검색을 위한 `searchProductsByName` 함수가 추가되었습니다.**
  - **`orderService.ts`**: 결제 완료된 '주문' 내역을 관리합니다. **또한, cancelOrder 함수에는 서버사이드 유효성 검사 로직이 추가되어 프론트엔드와 동일한 취소 정책을 서버에서도 이중으로 검증하여, 데이터 정합성과 보안을 강화합니다.**
  - **`generalService.ts`**: 배너, 카테고리 등 여러 곳에서 사용되는 공통 기능을 관리합니다.
  - **`pointService.ts`**: **포인트의 '화폐'적 측면을 관리하는 비즈니스 로직의 중심입니다.** `POINT_POLICIES` 객체를 통해 포인트 정책을 중앙에서 관리하며, 주문 상태 변경(`applyPointChangeByStatus`), 관리자 수동 조정(`adjustUserPoints`), '대기 순번 상승권' 사용(`applyWaitlistPriorityTicket`) 등 포인트가 변동되는 모든 경우의 수를 처리합니다.
- **`userService.ts`**: **사용자 정보 처리의 핵심입니다.** 신규 가입 시 사용자 문서를 생성하고(`processUserSignIn`), 이때 고유 추천인 코드를 자동으로 발급합니다. 또한, 기존 사용자가 로그인할 때 **`referredBy` 필드의 유무를 확인하여 `null`로 추가**해주는 등 데이터 스키마의 일관성을 보장합니다. 클라이언트에서 제출된 추천인 코드를 받아 **`processReferralCode` Cloud Function을 호출하는** 중요한 역할을 담당합니다.

- 다른 컴포넌트에서는 이 폴더의 각 서비스 파일에 정의된 함수를 import하여 사용함으로써 코드의 일관성과 재사용성을 높입니다.

### `src/App.tsx`

-   전체 애플리케이션의 **최상위 뼈대**를 구성하는 컴포넌트입니다.
-   **React Router**를 설정하여 URL 경로에 따라 다른 페이지 컴포넌트를 보여주는 라우팅을 담당합니다.
-   **모든 Context Provider**들(`AuthProvider`, `CartProvider` 등)이 이곳에서 앱 전체를 감싸, 하위 모든 컴포넌트가 전역 데이터에 접근할 수 있도록 합니다.
-   **`<Toaster />` 컴포넌트**가 위치하여, 앱 전역에서 `react-hot-toast` 알림을 사용할 수 있게 해줍니다.
-   `React.lazy`와 `Suspense`를 사용하여 페이지 로딩 시 **상황에 맞는 공용 로더**를 보여줌으로써 일관된 사용자 경험을 제공합니다.

### `src/layouts/CustomerLayout.tsx`

-   로그인한 고객이 보게 되는 모든 페이지의 **공통적인 뼈대(Layout)** 역할을 합니다.
-   화면 상단의 `<Header />`와 하단의 `<BottomNav />`가 이 컴포넌트에 포함되어 항상 표시됩니다.
-   **React Router의 모달 라우팅 로직을 처리하는 핵심 허브**입니다. `useLocation`의 `state`를 감지하여, 목록 페이지는 뒤에 그대로 유지한 채 `ProductDetailPage`를 모달로 띄우는 역할을 담당합니다.
-   모달이 열렸을 때 백그라운드 페이지의 스크롤을 막는 전역 스타일(`body`의 `overflow`)을 `useLayoutEffect`를 통해 직접 제어합니다.

### `src/pages/customer/ProductListPage.tsx`

고객용 앱의 메인 페이지입니다. Firebase로부터 배너와 상품 목록을 불러와 `productUtils.ts`의 로직에 따라 상품을 '오늘의 공동구매', '마감임박! 추가공구', '지난 공구' 등으로 분류합니다. **또한, 현재 로그인한 사용자의 등급을 기준으로 참여할 수 없는 상품은 목록에서 자동으로 필터링하여 보여주지 않습니다.**

### `src/pages/customer/ProductDetailPage.tsx`

-   상품의 상세 정보를 보여주는 모달 형태의 페이지 컴포넌트입니다.
-   **중앙 로직 사용**: `productUtils.ts`의 `determineActionState` 함수를 사용하여 '장바구니 담기', '대기 신청', '참여 등급 아님' 등 현재 상태에 맞는 버튼을 동적으로 정확하게 표시합니다.
-   **참여 조건 표시**: 만약 상품에 참여 등급 제한이 있을 경우, **어떤 등급이 참여할 수 있는지 명확하게 표시**하여 사용자에게 필요한 정보를 제공합니다.
-   `getOptimizedImageUrl` 유틸리티 함수를 사용하여 **최적화된 상세 이미지(1080x1080.webp)**를 로딩합니다.
-   **데이터 하위 호환성**을 지원합니다. `salesHistory` 기반의 신규 데이터 구조와 과거의 단일 판매 데이터 구조를 모두 자동으로 감지하고 처리하여, 어떤 데이터가 오든 에러 없이 상세 페이지를 렌더링합니다.
-   **개선된 UX**: 로딩 시에는 **스켈레톤 UI**를, 옵션 변경 시에는 **토스트 알림**을 제공합니다. '재고 무제한'과 같은 정보를 명확히 표시하여 사용자 경험을 향상시켰습니다.
-   **정교화된 구매 로직**: 상품의 상태('판매 중', '품절' 등)와 **시간(마감일 이전/이후)**을 모두 고려하여, '장바구니 담기', **'대기 신청'**, 또는 '앵콜 요청' 버튼을 사용자에게 가장 적합한 시점에 동적으로 정확하게 표시합니다.
-   **개선된 UI/UX**: 하단 구매 영역을 화면 맨 아래에 고정시키고, **`useLongPress` 훅**을 활용하여 수량 버튼을 길게 누르면 연속으로 숫자가 변경되는 등 사용자 편의성을 높였습니다.

### `src/pages/customer/OrderHistoryPage.tsx`

-   **지능형 예약 내역 관리의 중심지**: 고객의 모든 주문 내역을 효과적으로 조회하고 관리하기 위한 핵심 페이지입니다.
-   **두 가지 보기 모드 제공**: '예약 건별 보기'는 사용자의 개별 주문 내역을 주문 단위로 그룹화하여 보여줍니다. '픽업일 순 보기'는 여러 주문에 흩어져 있는 동일한 상품을 픽업일에 따라 자동 합산하여, "다음에 무엇을 총 몇 개 찾아가야 하는가"를 직관적으로 알려줍니다.
-   **대기 목록 탭 신설**: **'대기 목록' 탭이 신설되었습니다. 이곳에서 확정된 대기 내역을 관리하고 '대기 순번 상승권'을 사용하여 50포인트로 대기 순서를 올릴 수 있습니다.**
-   **정교한 예약 취소 정책 구현**: 상품의 한정/무제한 여부와 실시간 상황(마감일 임박 여부)을 기준으로 '자유 취소', '신중 취소', '취소 불가' 상태를 동적으로 결정합니다.
-   **사용자 경험을 고려한 피드백**: `toast.promise`를 활용하여 주문 취소 요청과 같은 비동기 처리 과정을 로딩, 성공, 실패 알림으로 명확하게 피드백합니다. 또한, 취소 성공 시 페이지를 새로고침하지 않고 즉시 UI를 업데이트하여 부드러운 사용자 경험을 제공합니다.
-   `useMemo`를 활용해 복잡한 주문 데이터를 '픽업 상품' 기준으로 재가공하고 집계하는 로직을 관리합니다. `handleCancelOrder` 함수를 통해 실제 서비스 로직과 UI 피드백을 연동합니다.

### `src/pages/customer/MyPage.tsx`

-   **사용자 정보의 허브 역할을 하는 핵심 페이지입니다.** 기존에 분산되어 있던 닉네임, 신뢰도 등급, 포인트 정보를 하나의 **'통합 프로필 카드'**로 시각화하여 제공합니다. 또한, 다음 등급까지 남은 픽업 횟수를 안내하고, 자신의 **'친구 초대 코드'**를 확인하고 복사하는 기능을 포함합니다. 사용자가 아직 추천인 코드를 입력하지 않았다면, 코드 입력 UI를 표시합니다.

### `src/pages/admin/ProductListPageAdmin.tsx`

-   **대표 상품 목록을 관리**하는 핵심 관리자 페이지입니다.
-   각 상품의 **가장 최신 판매 회차**의 상태, 가격 등 요약 정보를 테이블 형태로 표시합니다.
-   **'새 회차 추가'**, '판매 이력 보기', '대표 정보 수정' 등 상품과 관련된 모든 관리 기능의 진입점 역할을 수행합니다.
-   검색, 카테고리 필터, 판매 상태 필터, 정렬 등 다양한 편의 기능을 통해 원하는 상품을 쉽게 찾을 수 있도록 돕습니다.
-   **'드릴다운' 방식의 대기자 관리 기능이 통합되었습니다.** '예약/대기' 현황의 대기자 수를 클릭하여, 해당 상품의 대기자 명단을 모달 창에서 직접 확인하고 재고를 추가하여 자동으로 예약을 전환시킬 수 있습니다.

### ✅ [신규] `src/components/admin/ProductForm.tsx`

-   **상품 등록/수정의 통합 허브**: 기존 `ProductAddAdminPage`와 `SalesRoundEditPage`에 중복되어 있던 모든 UI와 로직을 통합한 **단일 폼 컴포넌트**입니다.
-   **모드 기반 동작**: `mode` prop (`newProduct`, `newRound`, `editRound`)에 따라 페이지의 제목, 데이터 로딩 방식, 제출 로직이 동적으로 변경됩니다.
-   이를 통해 코드 중복을 제거하고, 상품 관련 모든 폼의 UI/UX와 유지보수 일관성을 확보하는 핵심적인 역할을 합니다.

### `src/pages/admin/ProductAddAdminPage.tsx`

-   **✅ [수정] `ProductForm`의 래퍼(Wrapper) 컴포넌트**입니다.
-   URL 진입 방식(`location.state`)을 감지하여, `ProductForm`을 '신규 상품 등록' 모드 또는 '새 회차 추가' 모드로 렌더링하는 역할만 수행합니다.

### `src/pages/admin/SalesRoundEditPage.tsx`

-   **✅ [수정] `ProductForm`의 래퍼(Wrapper) 컴포넌트**입니다.
-   URL 파라미터(`:productId`, `:roundId`)를 가져와 `ProductForm`을 '판매 회차 수정' 모드로 렌더링하는 단순한 역할만 담당합니다.

### `src/pages/customer/LoginPage.tsx`

-   **카카오 소셜 로그인을 처리**하는 페이지입니다.
-   Firebase의 `OAuthProvider`와 `signInWithPopup` 함수를 사용하여 로그인 로직을 수행합니다.
-   로그인 과정(진행, 성공, 실패)을 **`toast.promise`** 를 통해 사용자에게 명확하게 피드백하여 직관적인 경험을 제공합니다.

-   **주요 기능:**
    -   **`callable/`**: 클라이언트(React 앱)에서 직접 호출하는 함수들 (실시간 재고 확인, 주문 제출, **추천인 코드 처리** 등)
    -   **`triggers/`**: Firestore 데이터 변경 시 자동으로 실행되는 함수들 (주문 생성 시 재고 집계, 등급 변경 알림 등)
    -   **`scheduled/`**: 정해진 시간에 주기적으로 실행되는 함수들 (포인트 자동 소멸, 알림톡 발송 등)
    -   **`http/`**: 외부 요청을 받는 HTTP 엔드포인트 (카카오 로그인 토큰 검증 등)
    
### `functions/src/triggers/orders.ts`
-   **주문과 관련된 모든 자동화 로직을 처리하는 핵심 트리거 파일**입니다.
-   주문 생성/삭제/변경 시 상품의 **예약 수량(`reservedCount`)을 업데이트**합니다.
-   `updateUserStatsOnOrderStatusChange` 함수를 통해, 주문 상태가 'PICKED_UP' 또는 'NO_SHOW'로 변경될 때 **사용자의 포인트, 픽업/노쇼 횟수, 신뢰 등급을 한 번에 업데이트**하고, 등급에 변동이 생기면 **축하 또는 안내 알림을 자동으로 발송**하는 매우 중요한 역할을 담당합니다.

### `functions/src/utils/helpers.ts`
-   **Cloud Functions 내부에서 사용되는 공통 유틸리티 파일**입니다.
-   클라이언트의 `loyaltyUtils.ts`와 **100% 동일한 로직의 `calculateTier` 함수**를 포함하여, 서버에서도 일관된 기준으로 등급을 계산하도록 보장합니다.
-   서버에서 사용되는 **전체 `POINT_POLICIES` 객체**를 정의하여, 모든 서버 기능이 통일된 포인트 정책을 따르도록 합니다.

### `src/components/common/SodomallLoader.tsx` 외

-   **앱 전체의 로딩 UI를 통일**하고, **상황에 맞는 경험을 제공**하기 위한 공용 컴포넌트 시스템입니다.
-   **`SodomallLoader.tsx`**: 화면 전체를 덮는 반투명 오버레이와 함께 '소도몰' 애니메이션을 표시합니다. 페이지 전체에 영향을 주는 작업(권한 확인, 폼 제출 등)에 사용됩니다.
-   **`InlineSodomallLoader.tsx`**: 오버레이 없이, 특정 영역 내부에서만 애니메이션을 표시합니다. `Suspense`의 `fallback`이나 페이지의 일부 콘텐츠만 로딩될 때 사용되어 다른 UI와의 상호작용을 방해하지 않습니다.
-   이 두 컴포넌트로 기존의 비일관적이던 로딩 스피너들을 모두 교체하여 일관성을 확보하고 유지보수성을 높였습니다.

### `src/components/customer/ProductCard.tsx`

상품 목록에 표시되는 개별 상품 카드 UI 컴포넌트입니다. **`productUtils.ts`의 중앙 로직(`determineActionState`)을 사용하여, 상세 페이지와 100% 동일한 기준으로 상품의 상태(담기, 옵션 선택, 품절, 대기 등)를 판별하고 다양한 버튼을 동적으로 보여줍니다.**
(개선) 수량 조절 기능이 대폭 향상되었습니다.
수량 표시 부분을 클릭하여 키보드로 직접 숫자를 입력할 수 있습니다.
+, - 버튼을 길게 누르면 수량이 연속으로 빠르게 변경됩니다.
(개선) '담기' 버튼을 누르면 실시간 재고를 확인하여 주문 가능 여부를 판단하고, 사용자에게 "✓ 담았어요"와 같은 명확한 시각적 피드백을 제공합니다.
상품의 재고 상태에 따라 '담기', '옵션 선택', '품절', '대기' 등 다양한 버튼을 동적으로 보여줍니다.

### `src/components/BottomNav.tsx`

-   화면 하단에 고정되어 주요 페이지로 빠르게 이동할 수 있게 해주는 **네비게이션 바 컴포넌트**입니다.
-   `NavLink`를 사용하여 현재 활성화된 메뉴를 시각적으로 표시합니다.
-   `useAuth`와 `useCart` 같은 Context를 사용하여, 관리자일 경우 '관리자' 메뉴를 추가로 보여주거나 장바구니에 담긴 상품 개수를 뱃지로 표시하는 등 동적인 UI를 제공합니다.

### `src/components/ProductSection.tsx`

-   `ProductListPage`에서 반복적으로 사용되는 **상품 목록 섹션을 담당하는 재사용 컴포넌트**입니다.
-   props로 products 배열을 직접 받는 대신, children을 받아 내부 컨텐츠를 유연하게 렌더링하는 구조로 변경되었습니다. 또한, 전용 스타일 파일(ProductSection.css)을 가져 독립성을 높였습니다.

### `src/hooks/useHorizontalScroll.ts`

-   **수평 스크롤 로직을 제공하는 커스텀 훅**입니다.
-   마우스 드래그를 통한 스크롤, 드래그 후 자연스러운 관성 스크롤 효과, 그리고 좌/우 화살표 버튼 클릭을 통한 스크롤 기능을 포함합니다.

### `src/types/react-html.d.ts`

-   TypeScript 환경에서 `<img>` 태그의 `fetchPriority`와 같은 **새로운 HTML 속성을 올바르게 인식하도록 확장**하는 타입 정의 파일입니다.
-   React의 기본 타입 정의에 포함되지 않은 웹 표준 속성을 안전하게 사용할 수 있도록 돕습니다.

### `src/utils/imageUtils.ts`

-   **이미지 관련 공통 유틸리티 함수**를 모아둔 파일입니다.
-   `getOptimizedImageUrl` 함수는 원본 이미지 URL을 받아, **Firebase Extensions (Resize Images)**를 통해 자동 생성된 **최적화된 WebP 이미지 URL로 변환**하는 핵심 역할을 수행합니다. 이를 통해 이미지 로딩 성능을 크게 향상시킵니다.

### `src/utils/productUtils.ts`

-   **상품 관련 비즈니스 로직의 중앙 허브**: 상품의 상태를 판별하는 모든 복잡한 로직을 담고 있는 핵심 유틸리티 파일입니다.
-   `getDisplayRound`: 상품의 여러 판매 이력(`salesHistory`) 중 현재 사용자에게 보여줘야 할 가장 적절한 판매 회차를 결정합니다.
-   `determineActionState`: 상품, 사용자 등급, 재고 등 모든 조건을 고려하여 현재 상품이 '예약 가능', '대기 가능', '참여 등급 아님' 등 어떤 상태인지를 판별하는 통합 함수를 제공합니다. 이를 통해 여러 페이지와 컴포넌트의 동작을 100% 통일시킵니다.

### ✅ [신규] `src/utils/loyaltyUtils.ts`
-   **신뢰 등급(Tier) 계산의 중심**: 사용자의 누적 픽업(`pickupCount`) 및 노쇼(`noShowCount`) 횟수를 기반으로, '공구의 신'부터 '참여 제한'까지의 **신뢰 등급을 계산하는 순수 함수(`calculateTier`)**를 관리합니다. 포인트와 등급이 분리된 새로운 시스템의 핵심 로직입니다.

### `src/context/CartContext.tsx`

-   **'예약'과 '대기' 상태 통합 관리**: `CartItem` 타입에 `status` 필드를 추가하여, 하나의 장바구니에서 '예약'과 '대기' 상품을 모두 관리합니다. `addToCart` 함수는 두 상태의 상품이 추가될 때 수량을 합치거나 상태를 변경하는 등 복합적인 로직을 처리합니다.
-   **일괄 처리 함수 제공**: 여러 상품을 한 번에 삭제하거나 상태를 변경하는 `removeItems`, `updateItemsStatus`와 같은 함수를 추가하여, `CartPage`의 일괄 삭제 및 자동 전환 기능을 지원합니다.

### `src/firebase/orderService.ts`

-   **재고 계산 정확성 향상**: 주문 생성(`submitOrder`) 시, 트랜잭션 외부에서 현재 예약된 총수량을 먼저 계산하여 전달함으로써 재고 계산의 정확성을 크게 향상시켰습니다. 이를 통해 동시 주문 시 발생할 수 있는 재고 불일치 문제를 방지합니다.

### `src/pages/customer/CartPage.tsx`

-   **지능형 장바구니의 중심**: 고객의 예약 및 대기 상품을 모두 관리하는 핵심 페이지입니다.
-   **선제적 자격 검사**: 페이지에 진입하는 순간, 장바구니에 담긴 모든 상품에 대해 **사용자의 현재 등급으로 참여 가능한지 여부를 미리 확인**합니다. 예약이 불가능한 상품은 시각적으로 비활성화 처리하고, 최종 결제 금액에서 자동으로 제외하여 사용자 경험을 향상시킵니다.
-   **대기 상품 자동 처리**: 페이지에 진입하는 순간, '대기' 상태인 상품의 실시간 재고를 확인합니다. 재고가 확보되면 해당 상품을 '예약' 상태로 자동 전환하고, 픽업 기한이 지난 상품은 자동 삭제하는 로직이 포함되어 있습니다.
-   **반응형 UI**: 모바일에서는 1단 목록으로, 데스크탑에서는 상품 목록과 주문 요약이 표시되는 2단 레이아웃으로 자동 전환됩니다.
-   **개선된 UX**: 상품 카드를 분리된 컴포넌트(`CartItemCard`)로 만들어 훅(Hook) 규칙 위반 오류를 해결했으며, 여러 상품을 선택하여 한 번에 삭제하는 일괄 처리 기능을 제공합니다.

### `src/components/customer/ProductCard.tsx`

-   **'대기' 기능 통합**: 품절 상품에 대한 '대기' 버튼은 이제 `status`가 'WAITLIST'인 상품 정보를 `CartContext`에 추가하는 역할을 수행하여, 모든 장바구니 관련 로직을 일원화했습니다.
-   **수량 조절 기능 개선**: 카드 내의 수량 조절 버튼(`QuantityInput`)이 자체 로직 대신, 프로젝트 전역에서 사용하는 `useLongPress` 커스텀 훅을 사용하도록 리팩터링하여 코드 중복을 제거하고 앱 전체의 버튼 동작 경험을 통일시켰습니다.

### `src/hooks/useLongPress.ts`

-   **'짧은 클릭'과 '꾹 누르기' 동작을 모두 처리하는 커스텀 훅**입니다.
-   사용자가 버튼을 짧게 클릭했을 때와 길게 누르고 있을 때의 동작을 명확하게 구분하여, 두 이벤트가 충돌해 기능이 중복 실행되는 문제를 해결합니다. 앱 전체에서 일관된 버튼 인터랙션 경험을 제공하는 핵심적인 역할을 합니다.

### ✅ [신규] `src/context/TutorialContext.tsx`
인터랙티브 튜토리얼의 중앙 제어실: 앱 전체의 튜토리얼 상태를 관리하는 Context입니다.

`isTourRunning` 상태를 통해 튜토리얼 실행 여부를 전역적으로 공유하여, 무한 스크롤과 같은 다른 기능과의 충돌을 방지합니다.

`runPageTourIfFirstTime` 함수는 Firestore에 저장된 사용자의 튜토리얼 진행 상태를 확인하고, 각 페이지에 처음 방문했을 때만 튜토리얼이 자동으로 실행되도록 제어하는 핵심 로직을 담당합니다.

### ✅ [신규] `src/components/customer/AppTour.tsx`
튜토리얼 UI 및 내용 정의: `react-joyride` 라이브러리를 실제로 렌더링하고, 각 페이지(메인, 상품 상세, 장바구니 등)에서 보여줄 튜토리얼의 단계(steps)와 내용을 모두 이곳에서 중앙 관리합니다.

튜토리얼이 종료되면 `TutorialContext`의 `stopTour` 함수를 호출하고, 메인 튜토리얼의 경우 Firestore에 완료 상태를 기록하는 역할

## ⚖️ 실시간 재고 관리 아키텍처

본 프로젝트의 실시간 재고 관리는 **클라이언트의 즉각적인 계산**과 **서버의 최종 검증**을 결합한 하이브리드 접근 방식을 채택한다.

### 핵심 원칙

-   **Source of Truth (신뢰의 원천):** 재고 수량의 최종적인 신뢰 원천은 `orders` 컬렉션에 기록된 실제 주문 내역이다.
-   **비동기적 집계의 한계:** `products` 문서 내에 트리거로 집계되는 `reservedCount` 필드는 편의성을 위해 사용될 수 있으나, 비동기적 업데이트로 인한 지연 가능성이 존재한다. 따라서 **재고를 차감하거나 최종 확인하는 민감한 로직**에서는 이 값에 의존해서는 안 된다.

### 동작 흐름

1.  **클라이언트 (사용자 화면):**
    - 상품 목록(`ProductListPage`) 또는 상세(`ProductDetailPage`)를 로드할 때, `products` 정보와 함께 `getReservedQuantitiesMap` 함수를 호출하여 `orders` 컬렉션에서 직접 실시간 예약 수량을 계산한다.
    - 이 계산된 값을 기준으로 사용자에게 "N개 남음"과 같은 UI를 즉시 보여준다.

2.  **서버 (Cloud Function - `checkCartStock`):**
    - 사용자가 장바구니 페이지에 진입하면, 클라이언트의 장바구니 정보를 받아 `checkCartStock` 함수가 실행된다.
    - 이 함수는 클라이언트와 **동일한 로직**으로 `orders` 컬렉션을 직접 조회하여 실시간 예약 수량을 계산한다.
    - 이 정확한 값을 기준으로 사용자의 장바구니에 담긴 상품 수량이 구매 가능한지 최종 검증하고, 불가능할 경우 클라이언트에 조정이 필요함을 알린다.

이 구조를 통해 사용자에게는 빠른 피드백을 제공함과 동시에, 서버에서는 데이터 정합성이 보장된 안정적인 재고 검증이 가능하다.