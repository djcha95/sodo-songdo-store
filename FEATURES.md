# ✨ 주요 기능 명세

## 👨‍👩‍👧‍👦 고객 기능

1.  **회원 인증 (로그인/로그아웃)**
    * **동작:** 사용자가 카카오 계정으로 로그인하고, 시스템이 사용자를 인식하여 메인 페이지로 이동시키는 과정입니다. 로그인 성공/실패 시 `toast` 알림으로 사용자에게 피드백을 제공합니다.
    * **핵심 파일:** `LoginPage.tsx`, `AuthContext.tsx`, `App.tsx`

2.  **상품 목록 보기 (메인 페이지)**
    * **동작:** 로그인한 사용자가 가장 처음 보게 되는 메인 페이지가 렌더링되고, 상품 데이터가 화면에 표시되는 과정입니다.
    * (개선) 상품 목록은 사용자 경험을 고려한 정렬 기준에 따라 배치됩니다. (한정 수량 우선, 품절 상품은 후순위 배치)
    * (개선) 상품 섹션은 마우스 드래그 스크롤과 좌/우 화살표 버튼을 통해 편리하게 탐색할 수 있으며, 이 기능은 데스크탑과 모바일 모두에서 일관되게 동작합니다.
    * **핵심 파일:** `ProductListPage.tsx`, `ProductSection.tsx`, `useHorizontalScroll.ts`

3.  **상품 상세 정보 보기**
    * **동작:** 메인 페이지에서 특정 상품을 클릭했을 때, **기존 페이지의 스크롤 위치는 그대로 유지된 채** 해당 상품의 상세 정보가 담긴 모달(modal) 창이 부드럽게 나타납니다. 장바구니 담기, 수량 조절 등의 상호작용 시 `toast` 알림으로 즉각적인 피드백을 제공합니다. 상품의 판매 상태에 따라 '장바구니 담기' 또는 '앵콜 요청' 버튼이 동적으로 정확하게 표시됩니다.
    * **핵심 파일:** `ProductDetailPage.tsx`, `CustomerLayout.tsx`, `ProductListPage.tsx`

4.  **장바구니 관리**
    * **동작:** 사용자가 상품을 장바구니에 담고, 확인하며, 최종적으로 예약을 확정하는 과정입니다.
    * (개선) 사용자가 장바구니 페이지에 진입하는 순간, **서버(Cloud Function)가 `orders` 컬렉션을 직접 조회**하여 최신 실시간 재고를 최종 확인합니다. 만약 그 사이에 다른 사용자가 구매하여 재고가 부족해졌다면, 장바구니의 상품 수량을 구매 가능한 수량으로 자동 조정하거나 품절 처리하여 동시 주문 문제를 원천적으로 방지합니다.
    * **핵심 파일:** `CartPage.tsx`, `ProductCard.tsx`, `CartContext.tsx`
    
5.  **대기(Waitlist) 기능**
    * **동작:** 품절 상품에 대해 '대기 신청' 시, 장바구니가 아닌 서버에 공식적으로 순번이 기록되는 **'대기 확정' 절차**를 거칩니다. 재고가 확보되면 이 순번에 따라 자동으로 예약이 전환되고, 앱 내 알림을 통해 즉시 알려줍니다.
    * **(개선) 엄격한 선착순(FIFO) 보장**: 동일 상품에 대기 신청을 여러 번 할 경우, 기존처럼 수량이 합산되지 않고 **별개의 대기 항목으로 각각 기록**됩니다. 이를 통해 먼저 신청한 순서가 명확히 보장됩니다.
    * **(개선) 부분 재고 처리**: 관리자가 추가한 재고가 대기 수량보다 적을 경우, 대기 순번이 빠른 사람부터 순서대로 **확보된 재고만큼만 부분적으로 예약이 전환**됩니다.
    * **(개선) '순서 올리기' 상세 규칙**: 확정된 대기 내역은 '예약/주문 내역 > 대기 목록' 탭에서 관리할 수 있으며, 아래의 규칙에 따라 '순서 올리기'가 가능합니다.
        - **포인트 사용:** 50 포인트를 사용하여 '순서 올리기' 또는 '1등 고정하기' 기능을 사용할 수 있습니다.
        - **우선순위 그룹:** 기능을 사용한 사용자는 '우선순위 그룹'으로 이동하며, 일반 대기자보다 항상 앞서게 됩니다.
        - **그룹 내 선착순:** '우선순위 그룹' 내에서는 **기능을 먼저 사용한 순서대로** 순번이 정해집니다.
        - **1등 특별 기능:** 현재 대기 순번이 1등인 사용자는 '순서 올리기' 대신 **"🏆 1등 고정하기"** 버튼이 표시됩니다. 이 기능을 사용하면 다른 사람이 나중에 '순서 올리기'를 사용해도 1등 자리를 뺏기지 않습니다.
        - **사용 횟수 제한:** '순서 올리기'와 '1등 고정하기'는 각 대기 항목당 **단 한 번만** 사용할 수 있습니다.
    * **핵심 파일:** `ProductDetailPage.tsx`, `OrderHistoryPage.tsx`, `functions/src/callable/waitlist.ts`, `functions/src/callable/points.ts`
    
6.  **'앵콜' 공동구매 요청**
    * **동작:** 판매가 마감되었거나 품절된 상품에 대해 사용자가 재판매를 요청하는 기능의 동작 흐름입니다. 요청 성공/실패 여부를 `toast` 알림으로 알려줍니다.
    * **핵심 파일:** `ProductDetailPage.tsx`, `EncoreRequestContext.tsx`, `firebase.ts`

7.  **지능형 예약 내역 관리**
    * **동작:** 사용자가 마이페이지를 통해 `orders` 컬렉션에 기록된 자신의 이전 주문(예약) 내역들을 확인합니다.
    * **두 가지 보기 모드 제공**: '주문일 순 보기'는 사용자의 개별 주문 내역을 주문 단위로 그룹화하여 보여주며, '픽업일 순 보기'는 여러 주문에 흩어진 동일 상품을 픽업일에 따라 자동 합산하여 "다음에 무엇을 총 몇 개 찾아가야 하는지"를 명확히 알려줍니다.
    * **정교한 예약 취소 정책**: 상품의 한정/무제한 여부와 실시간 상황(마감일 임박 여부)을 기준으로 '자유 취소', '신중 취소', '취소 불가' 상태가 동적으로 결정됩니다.
    * **사용자 경험을 고려한 피드백**: `toast.promise`를 활용하여 주문 취소와 같은 비동기 처리 상태를 로딩, 성공, 실패 알림으로 제공합니다. 취소 성공 시에는 페이지 새로고침 없이 UI가 즉시 업데이트되어 부드러운 사용자 경험을 제공합니다.
    * **핵심 파일:** `MyPage.tsx`, `OrderHistoryPage.tsx`, `firebase.ts`

8.  **✨ 신뢰도 시스템 개편: '신뢰 등급'과 '활동 포인트' 이중 트랙 시스템**
    * 프로젝트의 가장 핵심적인 기능으로, 고객과 운영자 간의 신뢰를 기반으로 설계되었습니다. 기존의 포인트-등급 연동 방식에서, **사용자의 장기적인 신뢰도**와 **단기적인 활동에 대한 보상**을 분리하여 더 공정하고 명확한 시스템으로 개편되었습니다.

    * **👑 1. 신뢰 등급 (Trust Tier): 사용자의 약속 이행에 대한 지표**
        * **개념:** 포인트 점수와 무관하게, 오직 사용자의 **'픽업률(Pickup Rate)'**만을 기준으로 산정되는 장기적인 신뢰의 척도입니다.
        * **산정 방식:** `픽업률 = (총 픽업 완료 건수) / (총 픽업 완료 건수 + 총 노쇼 건수) * 100`
        * **등급 체계 (기준 상향):**
            * **공구의 신:** 픽업률 98% 이상 & 누적 픽업 250회 이상
            * **공구왕:** 픽업률 95% 이상 & 누적 픽업 100회 이상
            * **공구요정:** 픽업률 90% 이상 & 누적 픽업 30회 이상
            * **공구새싹:** 그 외 모든 일반 사용자
            * **주의 요망:** 픽업률 70% 미만
            * **참여 제한:** 누적 노쇼 3회 이상
        * **피드백 강화**: 등급이 상승하거나 하락할 때, Cloud Function이 이를 자동으로 감지하여 사용자에게 **축하 또는 안내 알림을 발송**합니다.
        * **혜택 및 페널티**: 등급에 따라 '시크릿 상품', '선주문' 혜택을 받거나 '선입금 필수', '참여 제한' 등의 페널티가 적용됩니다.
        - **동기 부여 강화**: `마이페이지`에서는 현재 등급과 함께, **다음 등급까지 남은 픽업 횟수를 명확히 안내**하여 사용자의 지속적인 참여를 유도합니다.

    * **💰 2. 활동 포인트 (Activity Points): 서비스 활동에 대한 보상**
        * **개념:** 등급과 분리되어, 서비스 내 다양한 활동에 대한 **'보상'이자 '재화(Currency)'**의 역할을 합니다.
        * **포인트 획득:**
            * **(구매)** 상품 픽업 완료 시 **결제 금액의 0.5%**가 포인트로 적립됩니다. (선결제 시 추가 보너스 5P 지급)
            * **(활동)** 매일 첫 로그인 시 1P가 지급되며, **30일 연속 출석 시 보너스 100P**가 지급됩니다.
            * **(기타)** 리뷰 작성, 친구 초대 성공, 커뮤니티 홍보 등으로 추가 획득할 수 있습니다.
        * **포인트 차감 (페널티):**
            * 노쇼(미픽업) 시 -100P가 차감됩니다.
            * 마감 후 예약을 취소할 경우, **기본 페널티와 취소 금액에 비례한 페널티**가 함께 부과되어 더 공정하게 운영됩니다.
        * **포인트 사용 (대기 순번 상승권):** 50 포인트를 사용해 품절 상품의 대기 순번을 최상위로 올릴 수 있으며, 재고 미확보로 구매 실패 시 사용한 포인트는 자동으로 환불됩니다.
        * **포인트 소멸**: 획득한 지 1년이 지난 포인트는 매일 자정, 스케줄링된 Cloud Function에 의해 자동으로 소멸되어 시스템의 인플레이션을 방지합니다.

9.  **✨ 친구 초대 기능**
    * **동작**: 사용자가 자신의 초대 코드를 공유하고, 다른 사용자가 그 코드를 입력하여 양쪽 모두 즉시 포인트 보상을 받는 시스템입니다.
    * **초대 코드 확인**: 모든 사용자는 마이페이지의 '통합 프로필 카드' 하단에서 자신의 고유 초대 코드를 확인하고 복사할 수 있습니다.
    * **코드 입력**: 신규 사용자는 마이페이지에 한 번만 표시되는 입력란을 통해 친구의 초대 코드를 제출할 수 있습니다.
    * **보상 정책 (최종)**:
        - **코드를 입력한 사람**: 즉시 **30포인트**가 지급됩니다.
        - **코드를 제공한 사람**: 친구가 코드를 입력하는 즉시 **100포인트**가 지급됩니다.
    * **서버리스 백엔드 처리**: 추천 코드의 유효성 검사, 중복 입력 방지, 자기 자신 추천 방지, 두 사용자에 대한 포인트 동시 지급 등 모든 민감한 로직은 **`processReferralCode` Cloud Function**을 통해 서버에서 안전하게 처리됩니다.
    
10. **✨ 지능형 알림톡 시스템 (Alimtalk Notifications)**
    * **동작:** 고객의 주문 상태와 픽업일에 따라, 가장 적절한 시점에 개인화된 알림톡을 자동으로 발송하여 고객 경험을 향상시키고 '노쇼'를 방지합니다. 이 시스템은 Firebase Cloud Functions의 스케줄링 기능을 통해 완전히 자동화되어 있습니다.
    * **1차 실행 (오전 9시 - 픽업 안내):**
        - 매일 아침 9시, `sendPickupReminders` 함수가 실행되어 그날 픽업이 시작되는 모든 고객에게 알림을 보냅니다.
        - **'긴급 당일 마감'** 상품과 **'일반 픽업'** 상품이 섞여 있을 경우, 가장 긴급한 '당일 마감' 정보를 우선적으로 강조하여 고객의 실수를 방지합니다.
    * **2차 실행 (오후 7시 - 선입금 안내):**
        - 매일 저녁 7시, `sendPrepaymentReminders` 함수가 실행됩니다.
        - **'오늘이 픽업 마감일'**인 상품을 아직 찾아가지 않은 고객에게만, 마감 1시간 전에 '선입금' 전환을 안내하는 최종 리마인더를 발송하여 불이익을 막을 수 있는 구제책을 제공합니다.
    * **핵심 파일:** `functions/src/scheduled/notifications.ts`, `NHN Cloud Console` (템플릿 관리)

11. **✨ 인터랙티브 튜토리얼 시스템**
    * **동작**: 신규 가입자가 처음 메인 페이지에 방문하면, `react-joyride` 라이브러리를 활용한 가이드 투어가 자동으로 실행되어 서비스의 핵심 기능을 안내합니다. 메인 튜토리얼을 마친 후에는, 각 주요 페이지(상품 상세, 장바구니, 마이페이지 등)에 처음 방문할 때마다 해당 페이지의 기능을 설명하는 미니 튜토리얼이 한 번씩 자동으로 실행됩니다.
    * **상태 관리**: 사용자의 튜토리얼 진행 상태(`hasCompletedMain`, `hasSeenCartPage` 등)는 Firestore의 `users` 문서 내 `tutorialProgress` 객체에 기록되어, 튜토리얼이 불필요하게 반복 실행되는 것을 방지합니다.
    * **핵심 파일:** `AppTour.tsx`, `TutorialContext.tsx`, `ProductListPage.tsx`

---

## 🔐 관리자 기능

1.  **상품 및 판매 회차 관리**
    * **동작:** **대표 상품** 단위로 상품을 관리하며, 하나의 대표 상품에 여러 **'판매 회차'**를 등록하여 판매 이력을 누적하는 기능입니다. 관리자는 대표 상품 목록에서 최신 판매 상태를 확인하고, **'새 회차 추가'**를 통해 손쉽게 재판매를 시작하거나, **'이력 보기'**로 과거 판매 내역을 확인할 수 있습니다.
    * **핵심 파일:** `ProductListPageAdmin.tsx`, `ProductAddAdminPage.tsx`, `productService.ts`

2.  **주문 관리 (상태 변경 등)**
    * **동작:** 관리자가 고객들이 예약한 주문 내역을 전체적으로 확인하고, 각 주문의 처리 상태를 변경하는 기능입니다. 주문 상태 변경 시 `toast` 알림으로 관리자에게 피드백을 제공합니다.
    * **핵심 파일:** `OrderListPage.tsx`, `firebase.ts`

3.  **배너 관리 (등록/수정/순서 변경)**
    * **동작:** 관리자가 고객용 메인 페이지 상단에 노출되는 배너를 관리하는 기능의 흐름입니다. 배너 추가/수정/삭제 시 `toast` 알림을 활용합니다.
    * **핵심 파일:** `BannerAdminPage.tsx`, `BannerForm.tsx`, `BannerList.tsx`, `firebase.ts`

4.  **카테고리 관리**
    * **동작:** 관리자가 상품을 분류하기 위한 대분류 및 하위 카테고리를 생성하고 관리하는 기능의 흐름입니다. 카테고리 추가/수정/삭제 시 `toast` 알림을 사용합니다.
    * **핵심 파일:** `CategoryManagementPage.tsx`, `firebase.ts`

5.  **통합 재고 관리 (대시보드)**
    * **동작:** 관리자가 새롭게 개편된 **'통합 판매 현황 대시보드'**를 통해 모든 상품의 재고와 주문 현황을 관리합니다. 이 대시보드는 재고를 공유하는 하위 상품 그룹(예: '레몬맛')을 하나의 단위로 묶어, '그룹 총 재고'를 기준으로 예약 수량, 남은 수량 등을 명확하게 보여줍니다. 이를 통해 '1병', '1박스' 등 여러 판매 옵션이 하나의 재고를 공유하며 차감되는 복잡한 로직을 직관적으로 관리할 수 있습니다.
    * **핵심 파일:** `DashboardPage.tsx`, `productService.ts`, `orderService.ts`

6.  **대기자 관리 및 자동 예약 전환**
    * **동작:** 관리자가 '통합 판매 관리' 또는 '대시보드' 페이지에서 재고를 추가하면, `addStockAndProcessWaitlist` Cloud Function이 실행됩니다. 시스템은 추가된 재고만큼 대기 순번이 빠른 사용자부터 순서대로 '예약 확정' 상태로 자동 전환하고, 처리 결과를 즉시 피드백하며, 해당 고객에게는 앱 내 알림을 자동으로 발송합니다.
    * **핵심 파일:** `ProductListPageAdmin.tsx`, `productService.ts`, `orderService.ts`

7. **빠른 예약 확인 및 처리 페이지**
    * **동작**: 관리자가 고객 이름 또는 전화번호 뒷자리로 예약을 신속하게 검색하고, '픽업', '선입금', '노쇼' 등의 상태를 일괄적으로 처리할 수 있는 새로운 관리자 페이지입니다.
    * **핵심 파일**: `QuickCheckPage.tsx`

8. **✨ [신규] AI 기반 상품 정보 자동 등록**
    * **동작**: 관리자가 상품 등록 페이지의 '상세 설명' 입력란에 본사에서 전달받은 상품 안내문 전체를 붙여넣고 **'[AI로 채우기]'** 버튼을 클릭합니다.
    * **AI 역할**:
        -   비정형 텍스트를 분석하여 `상품명`, `가격`, `재고`, `유통기한`, `픽업일`, `보관 타입` 등 핵심 정보를 자동으로 추출합니다.
        -   **지능적 데이터 가공**:
            -   `소도몰X`와 같은 상점 접두사를 제거하여 **대표 상품명을 간소화**합니다.
            -   전체 상품명이 반복되는 대신 `1팩 (600g)`과 같이 **핵심 단위만 남도록 선택지 이름을 단순화**합니다.
            -   미리 정의된 **카테고리 목록 중에서 가장 적합한 카테고리를 자동으로 분류**하고 선택합니다.
            -   가격, 날짜 등 구조화된 정보를 제외하고 순수한 홍보 문구만 남도록 **상세 설명을 정제**합니다.
        -   추출 및 가공된 모든 정보를 상품 등록 폼의 각 필드에 자동으로 채워 넣어 관리자의 수동 입력 작업을 최소화합니다.
    * **핵심 파일:** `ProductForm.tsx`, `functions/src/callable/products.ts`, `functions/src/utils/gemini.ts`, `Google Cloud Secret Manager` (API 키 관리)

## 친구 초대 및 추천인 코드 시스템

사용자 간의 상호작용과 신규 사용자 유입을 촉진하기 위한 추천인 코드 시스템입니다.

-   **내 초대 코드**: 사용자는 마이페이지에서 자신의 고유 초대 코드를 확인할 수 있습니다.
-   **코드 입력**: 신규 사용자는 회원가입 후 마이페이지에서 추천인의 코드를 한 번만 입력할 수 있습니다.
-   **포인트 보상 정책**:
    -   **코드를 입력한 사람**: 즉시 **30포인트**가 지급됩니다.
    -   **코드를 제공한 사람**: 친구가 코드를 입력하면 즉시 **100포인트**가 지급됩니다.
-   **제한 사항**:
    -   추천인 코드 입력은 계정당 최초 1회만 가능합니다.
    -   자기 자신의 코드는 입력할 수 없습니다.