# λ°±μ—”λ“(Cloud Functions) μ κ²€ λ³΄κ³ μ„

**μ‘μ„±μΌ**: 2025λ…„ 1μ›”  
**μ κ²€ ν•­λ©**: κ΄€λ¦¬μ κ¶ν• κ²€μ¦, μμ•½/ν”½μ—… μ²λ¦¬ μ•μ •μ„±, λ―Έμ‚¬μ© ν•¨μ, μ„ν— ν¬μΈνΈ

---

## π”’ κ΄€λ¦¬μ κ¶ν• κ²€μ¦ ν„ν™©

### β… μ„λ²„μ—μ„ κ¶ν• κ²€μ¦μ΄ μ κµ¬ν„λ ν•¨μ

| ν•¨μ | νμΌ | κ²€μ¦ λ°©μ‹ | μƒνƒ |
|------|------|----------|------|
| `createOrderAsAdmin` | `callable/orders.ts` | `customClaims.role` μ²΄ν¬ | β… |
| `setUserRole` | `http/auth.ts` | `decodedToken.role` μ²΄ν¬ | β… |
| `reaggregateAllUserData` | `http/manualTrigger.ts` | `customClaims.role` μ²΄ν¬ | β… |
| `splitBundledOrder` | `callable/orders.ts` | μΈμ¦ μ²΄ν¬ (κ¶ν• κ²€μ¦ ν•„μ”) | β οΈ |

### β οΈ κ¶ν• κ²€μ¦μ΄ λ„λ½λκ±°λ‚ μ•½ν• ν•¨μ

| ν•¨μ | νμΌ | λ¬Έμ μ  | κ¶μ¥ μ΅°μΉ |
|------|------|--------|----------|
| `fixSalesHistoryHttp` | `http/maintenance.ts` | μ£Όμ„μΌλ΅λ§ κ¶ν• κ²€μ¦ μ•λ‚΄ | π”΄ μ¦‰μ‹ μ΅°μΉ ν•„μ” |
| `setAdminClaimForEmulator` | `callable/products.ts` | μ—λ®¬λ μ΄ν„° μ „μ© (μ΄μ ν™κ²½μ—μ„λ” μ•μ „) | β… |
| μΌλ¶€ HTTP ν•¨μ | `http/*.ts` | κ¶ν• κ²€μ¦ λ„λ½ κ°€λ¥μ„± | β οΈ ν™•μΈ ν•„μ” |

---

## π“¦ μμ•½ μƒμ„±/ν”½μ—… μ²λ¦¬ νλ¦„ μ•μ •μ„±

### μμ•½ μƒμ„± νλ¦„

#### 1. `submitOrder` (callable/orders.ts)
- **μ•μ •μ„±**: β… λ†’μ
- **κ²€μ¦ ν•­λ©**:
  - β… μ‚¬μ©μ μΈμ¦ ν™•μΈ
  - β… μ¬κ³  ν™•μΈ (νΈλμ­μ…)
  - β… μλ‰ μ ν• ν™•μΈ
  - β… μ¤‘λ³µ μ£Όλ¬Έ λ°©μ§€
- **μ„ν— ν¬μΈνΈ**: μ—†μ

#### 2. `validateCart` (callable/products.ts)
- **μ•μ •μ„±**: β… λ†’μ
- **κ²€μ¦ ν•­λ©**:
  - β… μ‚¬μ©μ μΈμ¦ ν™•μΈ
  - β… μ¬κ³  ν™•μΈ
  - β… μλ‰ μ ν• ν™•μΈ
- **μ„ν— ν¬μΈνΈ**: μ—†μ

### ν”½μ—… μ²λ¦¬ νλ¦„

#### 1. `confirmPickup` (callable/orders.ts)
- **μ•μ •μ„±**: β… λ†’μ
- **κ²€μ¦ ν•­λ©**:
  - β… μ‚¬μ©μ μΈμ¦ ν™•μΈ
  - β… μ£Όλ¬Έ μƒνƒ ν™•μΈ
  - β… νΈλμ­μ…μΌλ΅ μ•μ „ν• μ—…λ°μ΄νΈ
- **μ„ν— ν¬μΈνΈ**: μ—†μ

#### 2. `confirmNoShow` (callable/orders.ts)
- **μ•μ •μ„±**: β… λ†’μ
- **κ²€μ¦ ν•­λ©**:
  - β… μ‚¬μ©μ μΈμ¦ ν™•μΈ
  - β… μ£Όλ¬Έ μƒνƒ ν™•μΈ
  - β… νΈλμ­μ…μΌλ΅ μ•μ „ν• μ—…λ°μ΄νΈ
- **μ„ν— ν¬μΈνΈ**: μ—†μ

### νΈλ¦¬κ±° ν•¨μ

#### 1. `onOrderCreated` (triggers/orders.ts)
- **μ•μ •μ„±**: β… λ†’μ
- **κΈ°λ¥**: μ£Όλ¬Έ μƒμ„± μ‹ μλ™ μ²λ¦¬
- **μ„ν— ν¬μΈνΈ**: μ—†μ

#### 2. `onOrderUpdated` (triggers/orders.ts)
- **μ•μ •μ„±**: β οΈ μ£Όμ ν•„μ”
- **κΈ°λ¥**: μ£Όλ¬Έ μƒνƒ λ³€κ²½ μ‹ ν¬μΈνΈ/λ“±κΈ‰ μ—…λ°μ΄νΈ
- **μ„ν— ν¬μΈνΈ**: 
  - ν¬μΈνΈ κΈ°λ¥μ΄ λΉ„ν™μ„±ν™”λμ—μ§€λ§ νΈλ¦¬κ±°λ” μ—¬μ „ν μ‹¤ν–‰λ¨
  - π”΄ **μ¦‰μ‹ μ΅°μΉ ν•„μ”**: ν¬μΈνΈ κ΄€λ ¨ λ΅μ§ λΉ„ν™μ„±ν™”

---

## π—‘οΈ ν„μ¬ μ‚¬μ©λμ§€ μ•λ” ν•¨μ λ©λ΅

### μ™„μ „ν λΉ„ν™μ„±ν™”λ ν•¨μ

| ν•¨μ | νμΌ | μƒνƒ | λΉ„κ³  |
|------|------|------|------|
| `addWaitlistEntry` | `callable/waitlist.ts` | β… λΉ„ν™μ„±ν™” μ™„λ£ | λ€κΈ°μ λ…λ‹¨ κΈ°λ¥ λΉ„ν™μ„±ν™” |
| ν¬μΈνΈ κ΄€λ ¨ ν•¨μ | `callable/points.ts` | β… μ£Όμ„ μ²λ¦¬λ¨ | ν¬μΈνΈ κΈ°λ¥ λΉ„ν™μ„±ν™” |

### μ‚¬μ© κ°€λ¥ν•μ§€λ§ νΈμ¶λμ§€ μ•λ” ν•¨μ

| ν•¨μ | νμΌ | νΈμ¶ μ„μΉ | κ¶μ¥ μ΅°μΉ |
|------|------|----------|----------|
| `getWaitlistForRound` | `callable/products.ts` | κ΄€λ¦¬μ νμ΄μ§€ (λΉ„ν™μ„±ν™”λ¨) | β… μ΄λ―Έ λΉ„ν™μ„±ν™”λ¨ |
| `cancelWaitlistEntry` | `productService.ts` | ν΄λΌμ΄μ–ΈνΈ (λΉ„ν™μ„±ν™”λ¨) | β… μ΄λ―Έ λΉ„ν™μ„±ν™”λ¨ |

---

## π¨ μ‹¤μ΄μ μ¤‘ νΈμ¶λ  κ°€λ¥μ„±μ΄ μλ” μ„ν— ν¬μΈνΈ

### π”΄ μ¦‰μ‹ μ΅°μΉ ν•„μ”

#### 1. ν¬μΈνΈ κ΄€λ ¨ νΈλ¦¬κ±° ν•¨μ
- **νμΌ**: `functions/src/triggers/orders.ts`
- **λ¬Έμ **: μ£Όλ¬Έ μƒνƒ λ³€κ²½ μ‹ ν¬μΈνΈλ¥Ό κ³„μ‚°ν•κ³  μ—…λ°μ΄νΈν•λ” λ΅μ§μ΄ μ—¬μ „ν μ‹¤ν–‰λ¨
- **μ„ν—λ„**: λ†’μ
- **κ¶μ¥ μ΅°μΉ**:
  ```typescript
  // ν¬μΈνΈ κ³„μ‚° λ΅μ§μ„ μ£Όμ„ μ²λ¦¬ν•κ±°λ‚ μ΅°κ±΄λ¶€λ΅ λΉ„ν™μ„±ν™”
  // TODO: [λΉ„ν™μ„±ν™”] ν¬μΈνΈ κΈ°λ¥ λΉ„ν™μ„±ν™”
  // pointPolicy = { points: totalPoints, reason };
  ```
- **μν–¥**: ν¬μΈνΈ κΈ°λ¥μ΄ λΉ„ν™μ„±ν™”λμ—μ§€λ§ νΈλ¦¬κ±°λ” μ—¬μ „ν ν¬μΈνΈλ¥Ό κ³„μ‚°/μ—…λ°μ΄νΈ μ‹λ„

#### 2. ν¬μΈνΈ λ§λ£ μ¤μΌ€μ¤„λ¬
- **νμΌ**: `functions/src/scheduled/points.ts`
- **λ¬Έμ **: λ§¤μΌ μμ •μ— ν¬μΈνΈ λ§λ£ μ²λ¦¬λ¥Ό μ‹¤ν–‰
- **μ„ν—λ„**: μ¤‘
- **κ¶μ¥ μ΅°μΉ**: μ¤μΌ€μ¤„λ¬ λΉ„ν™μ„±ν™” λλ” ν¬μΈνΈ λ§λ£ λ΅μ§ μ£Όμ„ μ²λ¦¬

#### 3. ν¬μΈνΈ λ³€κ²½ μ•λ¦Ό νΈλ¦¬κ±°
- **νμΌ**: `functions/src/triggers/points.ts`
- **λ¬Έμ **: ν¬μΈνΈ λ³€κ²½ μ‹ μ•λ¦Όμ„ μƒμ„±ν•λ” νΈλ¦¬κ±°κ°€ μ‹¤ν–‰λ¨
- **μ„ν—λ„**: λ‚®μ (μ•λ¦Όλ§ μƒμ„±)
- **κ¶μ¥ μ΅°μΉ**: νΈλ¦¬κ±° λΉ„ν™μ„±ν™” λλ” μ΅°κ±΄λ¶€ μ‹¤ν–‰

#### 4. HTTP ν•¨μ κ¶ν• κ²€μ¦ λ„λ½
- **νμΌ**: `functions/src/http/maintenance.ts`
- **λ¬Έμ **: `fixSalesHistoryHttp` ν•¨μμ— κ¶ν• κ²€μ¦μ΄ μ—†μ
- **μ„ν—λ„**: λ§¤μ° λ†’μ
- **κ¶μ¥ μ΅°μΉ**: μ¦‰μ‹ κ¶ν• κ²€μ¦ μ¶”κ°€

### β οΈ λ‚μ¤‘μ— μ •λ¦¬ν•  μ‚¬ν•­

#### 1. λ―Έμ‚¬μ© ν•¨μ μ •λ¦¬
- λΉ„ν™μ„±ν™”λ ν•¨μλ“¤μ„ μ™„μ „ν μ κ±°ν•κ±°λ‚ λ³„λ„ νμΌλ΅ λ¶„λ¦¬
- μ½”λ“ κ°€λ…μ„± ν–¥μƒ

#### 2. λ΅κΉ… κ°•ν™”
- κ΄€λ¦¬μ μ‘μ—…μ— λ€ν• μƒμ„Έ λ΅κ·Έ κΈ°λ΅
- κ°μ‚¬ μ¶”μ  κ°€λ¥ν•λ„λ΅ κ°μ„ 

#### 3. μ—λ¬ μ²λ¦¬ κ°μ„ 
- μΌλ¶€ ν•¨μμ μ—λ¬ μ²λ¦¬κ°€ λ¶€μ΅±ν•  μ μμ
- μ „μ—­ μ—λ¬ ν•Έλ“¤λ¬ μ¶”κ°€ κ²€ν† 

---

## π“‹ κ¶μ¥ μ΅°μΉ μ‚¬ν•­ μ”μ•½

### π”΄ μ§€κΈ λ‹Ήμ¥ μ†λ€μ•Ό ν•  κ²ƒ

1. **ν¬μΈνΈ κ΄€λ ¨ νΈλ¦¬κ±°/μ¤μΌ€μ¤„λ¬ λΉ„ν™μ„±ν™”**
   - `functions/src/triggers/orders.ts` - ν¬μΈνΈ κ³„μ‚° λ΅μ§ μ£Όμ„ μ²λ¦¬
   - `functions/src/scheduled/points.ts` - μ¤μΌ€μ¤„λ¬ λΉ„ν™μ„±ν™”
   - `functions/src/triggers/points.ts` - νΈλ¦¬κ±° λΉ„ν™μ„±ν™”

2. **HTTP ν•¨μ κ¶ν• κ²€μ¦ μ¶”κ°€**
   - `functions/src/http/maintenance.ts` - `fixSalesHistoryHttp`μ— κ¶ν• κ²€μ¦ μ¶”κ°€
   - κΈ°νƒ€ HTTP ν•¨μλ“¤ κ¶ν• κ²€μ¦ ν™•μΈ

3. **κ΄€λ¦¬μ κΈ°λ¥ μ„λ²„ κ¶ν• κ²€μ¦ κ°•ν™”**
   - λ¨λ“  κ΄€λ¦¬μ μ „μ© ν•¨μμ— μ„λ²„ κ¶ν• κ²€μ¦ μ¶”κ°€
   - ν΄λΌμ΄μ–ΈνΈ κ¶ν• κ²€μ¦λ§μΌλ΅λ” λ¶€μ΅±

### β… μ™„λ£λ μ‘μ—… (2025λ…„ 1μ›”)

1. **λ΅κΉ… λ° κ°μ‚¬ μ‹μ¤ν… κµ¬μ¶•** β…
   - `functions/src/utils/auditLogger.ts` μƒμ„±
   - κ΄€λ¦¬μ μ‘μ—…μ„ Firestore `adminAuditLogs` μ»¬λ ‰μ…μ— κΈ°λ΅
   - `withAuditLog` ν—¬νΌ ν•¨μλ΅ μλ™ κ°μ‚¬ λ΅κΉ…
   - μ£Όμ” κ΄€λ¦¬μ ν•¨μμ— κ°μ‚¬ λ΅κΉ… μ μ©:
     - `createOrderAsAdmin` (callable/orders.ts)
     - `addProductWithFirstRound` (callable/products.ts)
     - `fixSalesHistoryHttp` (http/maintenance.ts)

2. **μ—λ¬ μ²λ¦¬ κ°μ„ ** β…
   - `functions/src/utils/errorHandler.ts` μƒμ„±
   - κµ¬μ΅°ν™”λ μ—λ¬ μ²λ¦¬ μ‹μ¤ν… κµ¬μ¶•
   - μ—λ¬ μΉ΄ν…κ³ λ¦¬ λ¶„λ¥ (μΈμ¦, κ¶ν•, κ²€μ¦, λ‚΄λ¶€ λ“±)
   - `withErrorHandling` ν—¬νΌ ν•¨μλ΅ μλ™ μ—λ¬ μ²λ¦¬
   - μ‚¬μ©μ μΉν™”μ μΈ μ—λ¬ λ©”μ‹μ§€ μ κ³µ

3. **λ―Έμ‚¬μ© ν•¨μ μ •λ¦¬** β…
   - λΉ„ν™μ„±ν™”λ ν•¨μλ“¤μ€ μ£Όμ„ μ²λ¦¬ μƒνƒλ΅ μ μ§€ (ν–¥ν›„ λ³µκµ¬ κ°€λ¥)
   - `functions/src/disabled/` λ””λ ‰ν† λ¦¬ μƒμ„± (ν–¥ν›„ μ •λ¦¬μ©)
   - λΉ„ν™μ„±ν™”λ ν•¨μ λ©λ΅:
     - `addWaitlistEntry` (callable/waitlist.ts)
     - `updateUserStatsOnOrderStatusChange` (triggers/orders.ts)
     - `rewardReferrerOnFirstPickup` (triggers/orders.ts)
     - `expirePointsScheduled` (scheduled/points.ts)
     - `createNotificationOnPointChange` (triggers/points.ts)
     - `markOverdueOrdersAsNoShow` (scheduled/orders.ts)

---

## β… μ•μ •μ μΌλ΅ μ‘λ™ν•λ” λ¶€λ¶„

1. **μμ•½ μƒμ„± νλ¦„**: νΈλμ­μ…μΌλ΅ μ•μ „ν•κ² μ²λ¦¬λ¨
2. **ν”½μ—… μ²λ¦¬ νλ¦„**: νΈλμ­μ…μΌλ΅ μ•μ „ν•κ² μ²λ¦¬λ¨
3. **μ¬κ³  κ΄€λ¦¬**: νΈλμ­μ…μΌλ΅ μ•μ „ν•κ² μ²λ¦¬λ¨
4. **λ€λ¶€λ¶„μ κ΄€λ¦¬μ κ¶ν• κ²€μ¦**: μ„λ²„μ—μ„ μ κµ¬ν„λ¨

---

## π“ μ¶”κ°€ ν™•μΈ μ‚¬ν•­

1. **Firestore Security Rules**: ν΄λΌμ΄μ–ΈνΈμ—μ„ μ§μ ‘ μ ‘κ·Όν•λ” κ²½μ° λ³΄μ• κ·μΉ™ ν™•μΈ ν•„μ”
2. **CORS μ„¤μ •**: HTTP ν•¨μμ CORS μ„¤μ • ν™•μΈ ν•„μ”
3. **νƒ€μ„μ•„μ›ƒ μ„¤μ •**: μ¥μ‹κ°„ μ‹¤ν–‰λλ” ν•¨μμ νƒ€μ„μ•„μ›ƒ μ„¤μ • ν™•μΈ ν•„μ”
4. **λ©”λ¨λ¦¬ μ„¤μ •**: λ€μ©λ‰ λ°μ΄ν„° μ²λ¦¬ ν•¨μμ λ©”λ¨λ¦¬ μ„¤μ • ν™•μΈ ν•„μ”

